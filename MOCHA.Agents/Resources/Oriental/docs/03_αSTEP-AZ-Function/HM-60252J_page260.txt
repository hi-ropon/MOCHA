ファイル名: HM-60252J_page260

<overview>
本ページは「メッセージ構成」についての説明で構成されています。  
テキスト部分では、メッセージのフォーマット概要、クエリの構成要素（サーバーアドレス、ファンクションコード、データ、エラーチェック）について詳細に解説しています。  
表部分では、クエリの各項目のビット数やファンクションコードの機能一覧が示されています。  
図部分はなく、文章と表による構成です。
</overview>

<contents>
### テキスト
#### メッセージ構成
メッセージのフォーマットを示しています。  
クライアントからサーバーへクエリを送り、サーバーからレスポンスを返す構造です。  
クエリは「サーバーアドレス」「ファンクションコード」「データ」「エラーチェック」から構成されます。

#### 2-1 クエリ
クエリのメッセージ構成は以下の通りです。

| サーバーアドレス | ファンクションコード | データ | エラーチェック |
| :--- | :--- | :--- | :--- |
| 8ビット | 8ビット | N×8ビット | 16ビット |

##### ■ サーバーアドレス
- ユニキャストモードでサーバーアドレスを指定します。  
- 0を設定すると全サーバーにクエリを送信する（ブロードキャストモード）。

##### ■ ファンクションコード
ドライバがサポートするファンクションコードとメッセージ長は以下の通りです。

| ファンクションコード | 機能 | レジスタ数 | ブロードキャスト |
| :--- | :--- | :--- | :--- |
| 03h | 保持レジスタからの読み出し | 1～125 | 不可 |
| 06h | 保持レジスタへの書き込み | 1 | 可 |
| 08h | 診断 | - | 不可 |
| 10h | 複数の保持レジスタへの書き込み | 1～123 | 可 |
| 17h | 複数の保持レジスタの読み出し/書き込み | 読み出し:1～125 書き込み:1～121 | 不可 |

##### ■ データ
ファンクションコードに関連するデータを設定。ファンクションコードによりデータ長は変化。

##### ■ エラーチェック
- Modbus RTUモードのエラーチェックはCRC-16方式を採用。  
- サーバーは受信メッセージのCRC-16を計算し、メッセージ内のエラーチェック値と比較。  
- 一致すれば正常なメッセージと判断。

● CRC-16の計算方法  
1. 初期値をFFFFhとし、FFFFhとサーバーアドレス(8ビット)の排他的論理和(XOR)を計算。  
2. 手順1の結果を1ビット右へシフト。シフトはあふれたビットが「1」になるまで繰り返す。  
3. あふれたビットが「1」になったら、手順2の結果とA001hのXORを計算。  
4. シフトが8回になるまで手順2と3を繰り返す。  
5. 手順4の結果とファンクションコード(8ビット)のXORを計算。  
6. すべてのバイトに対して手順2から4を繰り返し、最後の結果がCRC-16の計算結果となる。
</contents>