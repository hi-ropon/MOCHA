@page "/plc/function-blocks"
@using System.Globalization
@using Microsoft.AspNetCore.Components.Forms
@using MOCHA.Services.Architecture
@using MOCHA.Services.Agents
@inject FunctionBlockApiClient ApiClient
@inject DeviceAgentState AgentState
@inject NavigationManager Navigation

<h1>ファンクションブロック管理</h1>

<div class="fb-card">
    <div class="fb-section">
        <label>エージェント番号</label>
        <input class="fb-input" @bind="agentNumber" placeholder="例: A-01" />
        <button class="fb-btn" @onclick="LoadUnitsAsync" disabled="@isLoading">ユニット取得</button>
    </div>
    <div class="fb-section">
        <label>PLCユニット</label>
        <select class="fb-input" @bind="selectedUnitId">
            <option value="">選択してください</option>
            @foreach (var unit in units)
            {
                <option value="@unit.Id">@unit.Name (@unit.Role)</option>
            }
        </select>
        <button class="fb-btn" @onclick="LoadAsync" disabled="@isLoading || string.IsNullOrWhiteSpace(selectedUnitId)">一覧取得</button>
    </div>
</div>

<div class="fb-card">
    <h2>アップロード</h2>
    <div class="fb-grid">
        <div class="fb-field">
            <label>ファンクションブロック名</label>
            <input class="fb-input" @bind="newName" />
        </div>
        <div class="fb-field">
            <label>ラベルCSV</label>
            <InputFile OnChange="OnLabelChange" />
            <div class="fb-hint">@labelFileName</div>
        </div>
        <div class="fb-field">
            <label>プログラムCSV</label>
            <InputFile OnChange="OnProgramChange" />
            <div class="fb-hint">@programFileName</div>
        </div>
    </div>
    <button class="fb-btn primary" @onclick="UploadAsync" disabled="@isUploading">アップロード</button>
    @if (!string.IsNullOrWhiteSpace(message))
    {
        <div class="fb-message">@message</div>
    }
</div>

<div class="fb-card">
    <h2>登録済み</h2>
    @if (isLoading)
    {
        <div>読み込み中...</div>
    }
    else if (functionBlocks.Count == 0)
    {
        <div>データなし</div>
    }
    else
    {
        <table class="fb-table">
            <thead>
                <tr>
                    <th>名前</th>
                    <th>作成</th>
                    <th>更新</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var fb in functionBlocks)
                {
                    <tr>
                        <td>@fb.Name</td>
                        <td>@fb.CreatedAt.ToLocalTime().ToString("yyyy/MM/dd HH:mm", CultureInfo.InvariantCulture)</td>
                        <td>@fb.UpdatedAt.ToLocalTime().ToString("yyyy/MM/dd HH:mm", CultureInfo.InvariantCulture)</td>
                        <td>
                            <button class="fb-btn danger" @onclick="() => DeleteAsync(fb.Id)">削除</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private readonly List<PlcUnitSummary> units = new();
    private string? agentNumber;
    private string? selectedUnitId;
    private Guid? plcUnitId;
    private string newName = string.Empty;
    private IBrowserFile? labelFile;
    private IBrowserFile? programFile;
    private string? labelFileName;
    private string? programFileName;
    private bool isLoading;
    private bool isUploading;
    private string? message;
    private List<FunctionBlockSummary> functionBlocks = new();

    protected override async Task OnInitializedAsync()
    {
        agentNumber = AgentState.SelectedAgentNumber;
        if (!string.IsNullOrWhiteSpace(agentNumber))
        {
            await LoadUnitsAsync();
        }
    }

    private async Task LoadUnitsAsync()
    {
        message = null;
        units.Clear();
        functionBlocks.Clear();

        if (string.IsNullOrWhiteSpace(agentNumber))
        {
            message = "エージェント番号を入力してください";
            return;
        }

        isLoading = true;
        try
        {
            var list = await ApiClient.ListUnitsAsync(agentNumber!, CancellationToken.None);
            units.AddRange(list);
            selectedUnitId ??= units.FirstOrDefault()?.Id.ToString();
        }
        catch (Exception ex)
        {
            message = $"ユニット取得に失敗しました: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadAsync()
    {
        message = null;
        functionBlocks.Clear();

        if (!ValidateInputs(out var error))
        {
            message = error;
            return;
        }

        isLoading = true;
        try
        {
            var items = await ApiClient.ListAsync(plcUnitId!.Value, agentNumber!, CancellationToken.None);
            functionBlocks = items.ToList();
        }
        catch (Exception ex)
        {
            message = $"取得に失敗しました: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UploadAsync()
    {
        message = null;
        if (!ValidateInputs(out var error))
        {
            message = error;
            return;
        }

        if (labelFile is null || programFile is null)
        {
            message = "ラベルとプログラムの両方を選択してください";
            return;
        }

        if (string.IsNullOrWhiteSpace(newName))
        {
            message = "ファンクションブロック名を入力してください";
            return;
        }

        isUploading = true;
        try
        {
            using var labelStream = labelFile.OpenReadStream(long.MaxValue);
            using var programStream = programFile.OpenReadStream(long.MaxValue);
            var ok = await ApiClient.UploadAsync(plcUnitId!.Value, agentNumber!, newName.Trim(), labelStream, labelFile.Name, programStream, programFile.Name, CancellationToken.None);
            message = ok ? "アップロードしました" : "アップロードに失敗しました";
            if (ok)
            {
                await LoadAsync();
                newName = string.Empty;
                labelFile = null;
                programFile = null;
                labelFileName = null;
                programFileName = null;
            }
        }
        catch (Exception ex)
        {
            message = $"アップロードエラー: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private async Task DeleteAsync(Guid id)
    {
        if (!ValidateInputs(out var error))
        {
            message = error;
            return;
        }

        try
        {
            var ok = await ApiClient.DeleteAsync(plcUnitId!.Value, id, agentNumber!, CancellationToken.None);
            if (ok)
            {
                functionBlocks.RemoveAll(f => f.Id == id);
            }
            else
            {
                message = "削除に失敗しました";
            }
        }
        catch (Exception ex)
        {
            message = $"削除エラー: {ex.Message}";
        }
    }

    private void OnLabelChange(InputFileChangeEventArgs e)
    {
        labelFile = e.File;
        labelFileName = e.File.Name;
    }

    private void OnProgramChange(InputFileChangeEventArgs e)
    {
        programFile = e.File;
        programFileName = e.File.Name;
    }

    private bool ValidateInputs(out string? error)
    {
        error = null;
        if (string.IsNullOrWhiteSpace(agentNumber))
        {
            error = "エージェント番号を入力してください";
            return false;
        }

        if (string.IsNullOrWhiteSpace(selectedUnitId) || !Guid.TryParse(selectedUnitId, out var parsed))
        {
            error = "PLCユニットを選択してください";
            return false;
        }

        plcUnitId = parsed;
        return true;
    }
}