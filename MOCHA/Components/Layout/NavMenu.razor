@using System
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.IO
@using MOCHA.Models.Chat
@using MOCHA.Models.Agents
@using MOCHA.Models.Settings
@using MOCHA.Models.Auth
@using MOCHA.Models.Drawings
@using MOCHA.Models.Architecture
@inject NavigationManager NavigationManager
@inject MOCHA.Services.Chat.ConversationHistoryState HistoryState
@inject MOCHA.Services.Agents.DeviceAgentState AgentState
@inject MOCHA.Services.Settings.UserPreferencesState PreferencesState
@inject IUserRoleProvider RoleProvider
@inject MOCHA.Services.Drawings.DrawingRegistrationService DrawingService
@inject MOCHA.Services.Architecture.PlcConfigurationService PlcService
@inject IJSRuntime JsRuntime
@inherits LayoutComponentBase
@implements IDisposable

<div class="sidebar-container @(IsCollapsed ? "collapsed" : string.Empty)">
    <div class="sidebar-header">
    <div class="sidebar-title">
        <img src="icon.png" alt="Chat" class="sidebar-title-icon" />
        @if (isAdmin)
        {
            <button type="button" class="sidebar-admin-btn" title="„É≠„Éº„É´ÁÆ°ÁêÜ" @onclick="NavigateToRoles">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M12 3.2 5 6v5.3c0 4 3 7.5 7 8.5 4-1 7-4.5 7-8.5V6l-7-2.8Z" stroke="currentColor" stroke-width="1.4" fill="none" />
                    <path d="M12 12.2a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" stroke="currentColor" stroke-width="1.4" fill="none" />
                    <path d="M8.8 16.1c.5-1.2 1.8-2.1 3.2-2.1s2.7.9 3.2 2.1" stroke="currentColor" stroke-width="1.4" fill="none" stroke-linecap="round" />
                </svg>
                <span class="sr-only">„É≠„Éº„É´ÁÆ°ÁêÜ</span>
            </button>
        }
        <span class="sr-only">Chat</span>
    </div>
        <button class="new-chat-btn" @onclick="StartNewChat">New Chat</button>
        <button class="sidebar-toggle" type="button" @onclick="ToggleAsync" title="„Çµ„Ç§„Éâ„Éê„ÉºÂàáÊõø">
            @(IsCollapsed ? "‚Ä∫" : "‚Äπ")
        </button>
    </div>

    <div class="agent-section">
        <div class="agent-label">Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà</div>
        <div class="agent-select-row">
            <select class="agent-select" value="@selectedAgentNumber" @onchange="OnAgentChanged">
                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                @foreach (var agent in AgentState.Agents.OrderBy(a => a.Number))
                {
                    <option value="@agent.Number">@agent.Name - @agent.Number</option>
                }
            </select>
            @if (CanManageAgents)
            {
                <button type="button" class="agent-gear-btn" title="„Ç®„Éº„Ç∏„Çß„É≥„ÉàË®≠ÂÆö" @onclick="ToggleSettings">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.5" fill="none" />
                        <path d="M19.4 13.5a7.9 7.9 0 0 0 0-3l1.9-1.5a.7.7 0 0 0 .2-.8l-1.8-3.1a.7.7 0 0 0-.8-.3l-2.2.9a8.4 8.4 0 0 0-2.6-1.5l-.3-2.3a.7.7 0 0 0-.7-.6h-3.6a.7.7 0 0 0-.7.6L8.8 3.9a8.4 8.4 0 0 0-2.6 1.5l-2.2-.9a.7.7 0 0 0-.8.3L1.4 8a.7.7 0 0 0 .2.8l1.9 1.5a7.9 7.9 0 0 0 0 3l-1.9 1.5a.7.7 0 0 0-.2.8l1.8 3.1c.2.3.5.4.8.3l2.2-.9a8.4 8.4 0 0 0 2.6 1.5l.3 2.3c0 .3.3.6.7.6h3.6c.4 0 .7-.3.7-.6l.3-2.3a8.4 8.4 0 0 0 2.6-1.5l2.2.9c.3.1.6 0 .8-.3l1.8-3.1a.7.7 0 0 0-.2-.8l-1.9-1.5Z" stroke="currentColor" stroke-width="1.5" fill="none" />
                    </svg>
                </button>
            }
        </div>
        <div class="agent-note">
            @if (!string.IsNullOrWhiteSpace(selectedAgentName))
            {
                <span>@selectedAgentName</span>
            }
            else
            {
                <span class="agent-warning">Êú™ÈÅ∏Êäû</span>
            }
        </div>
    </div>

    <div class="sessions-list">
        @if (HistoryState.Summaries.Any())
        {
            @foreach (var item in HistoryState.Summaries.OrderByDescending(h => h.UpdatedAt))
            {
                <div class="session-item" @onclick="() => OpenConversation(item.Id)">
                    <div class="session-content">
                        <div class="history-title">@(!string.IsNullOrWhiteSpace(item.Title) ? item.Title : "„Çø„Ç§„Éà„É´ÁîüÊàê‰∏≠‚Ä¶")</div>
                        <div class="history-time">@item.UpdatedAt.ToLocalTime().ToString("MM/dd HH:mm")</div>
                    </div>
                    <button type="button"
                            class="session-menu-btn"
                            title="Â±•Ê≠¥„ÇíÂâäÈô§"
                            aria-label="Â±•Ê≠¥„ÇíÂâäÈô§"
                            @onclick:stopPropagation="true"
                            @onclick="() => ConfirmDeleteAsync(item)">
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <path d="M9 3.5h6m-9 3h12M10 10.5v7m4-7v7M5.5 6.5l1 13a1 1 0 0 0 1 .92h9a1 1 0 0 0 1-.92l1-13" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                            <path d="M9 4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                        </svg>
                    </button>
                </div>
            }
        }
        else
        {
            <div class="history-empty">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        }
    </div>

<button type="button" class="user-info" @onclick="OpenUserActions" title="„É¶„Éº„Ç∂„ÉºË®≠ÂÆö">
    <div class="user-avatar">@userInitial</div>
    <div>
        <div class="user-name">@userName</div>
    </div>
</button>
</div>

@if (_settingsOpen)
{
    <div class="agent-settings-overlay" @onclick="CloseOverlay">
        <div class="agent-settings-dialog" @onclick:stopPropagation="true">
            <div class="agent-settings-header">
                <div>
                    <div class="agent-settings-title">Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„ÉàË®≠ÂÆö</div>
                    <div class="agent-settings-subtitle">ÁôªÈå≤„ÉªÂâäÈô§„ÇÑ‰ªäÂæå„ÅÆË®≠ÂÆöÊã°Âºµ„Çí„Åæ„Å®„ÇÅ„Å¶ÁÆ°ÁêÜ„Åó„Åæ„Åô</div>
                </div>
                <button type="button" class="agent-settings-close" title="Èñâ„Åò„Çã" @onclick="CloseOverlay">
                    √ó
                </button>
            </div>

            <div class="agent-settings-body">
                <div class="agent-settings-section">
                    <div class="field">
                        <label for="agent-name">ÂêçÂâç</label>
                        <input id="agent-name"
                               class="agent-input"
                               @bind="agentNameInput"
                               placeholder="Ë£ÖÁΩÆÂêç„Å™„Å©" />
                    </div>
                    <div class="field">
                        <label for="agent-number">Áï™Âè∑</label>
                        <input id="agent-number"
                               class="agent-input"
                               @bind="agentNumberInput"
                               placeholder="‰æã: A-01" />
                    </div>
                    <button class="new-chat-btn save-agent-btn"
                            @onclick="RegisterAgentAsync"
                            disabled="@(_isRegistering || string.IsNullOrWhiteSpace(agentNumberInput) || string.IsNullOrWhiteSpace(agentNameInput))">
                        ÁôªÈå≤
                    </button>
                </div>

                <div class="agent-settings-section">
                    <div class="agent-settings-section-title">ÁôªÈå≤Ê∏à„Åø„Ç®„Éº„Ç∏„Çß„É≥„Éà</div>
                    <div class="agent-list">
                        @if (AgentState.Agents.Any())
                        {
                            @foreach (var agent in AgentState.Agents.OrderBy(a => a.Number))
                            {
                                <div class="agent-row">
                                    <div class="agent-row-info">
                                        <div class="agent-row-name">@agent.Name</div>
                                        <div class="agent-row-number">@agent.Number</div>
                                    </div>
                                    <button type="button"
                                            class="agent-delete-btn"
                                            title="„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÂâäÈô§"
                                            @onclick="() => ConfirmDeleteAgentAsync(agent)">
                                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                            <path d="M9 3.5h6m-9 3h12M10 10.5v7m4-7v7M5.5 6.5l1 13a1 1 0 0 0 1 .92h9a1 1 0 0 0 1-.92l1-13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                                            <path d="M9 4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                                        </svg>
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="agent-list-empty">„Ç®„Éº„Ç∏„Çß„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        }
                    </div>
                </div>

                <div class="agent-settings-section architecture-manager">
                    <div class="drawing-header">
                        <div>
                            <div class="agent-settings-section-title">„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£Ë®≠ÂÆö</div>
                            <div class="drawing-subtitle">PLC„É¶„Éã„ÉÉ„Éà„ÇíË§áÊï∞Âè∞ÁôªÈå≤„Åó„ÄÅ„É¢„Ç∏„É•„Éº„É´„Å®„Éï„Ç°„Ç§„É´„ÇíÁÆ°ÁêÜ</div>
                        </div>
                        <button type="button"
                                class="new-chat-btn save-agent-btn drawing-open-btn"
                                @onclick="OpenPlcModalForCreate"
                                disabled="@(string.IsNullOrWhiteSpace(selectedAgentNumber))">
                            PLC„É¶„Éã„ÉÉ„Éà„ÇíËøΩÂä†
                        </button>
                    </div>
                    <div class="drawing-permission">Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„Åî„Å®„Å´PLC„ÇíÁ¥ê„Å•„Åë„Åæ„Åô</div>

                    @if (string.IsNullOrWhiteSpace(selectedAgentNumber))
                    {
                        <div class="drawing-empty">Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    }
                    else if (_plcUnits.Any())
                    {
                        <div class="plc-list">
                            @foreach (var plc in _plcUnits)
                            {
                                <div class="plc-card">
                                    <div class="plc-title-row">
                                        <div>
                                            <div class="plc-name">@plc.Name</div>
                                            <div class="plc-meta">@(!string.IsNullOrWhiteSpace(plc.Model) ? plc.Model : "Êú™Ë®≠ÂÆö")</div>
                                        </div>
                                        <div class="plc-actions">
                                            <button type="button"
                                                    class="agent-delete-btn drawing-edit-btn"
                                                    @onclick="() => OpenPlcModalForEdit(plc)">
                                                Á∑®ÈõÜ
                                            </button>
                                            <button type="button"
                                                    class="agent-delete-btn danger-btn"
                                                    @onclick="() => DeletePlcUnitAsync(plc)">
                                                ÂâäÈô§
                                            </button>
                                        </div>
                                    </div>
                                    <div class="plc-row">
                                        <span class="plc-label">ÂΩπÂâ≤:</span>
                                        <span class="plc-value">@(!string.IsNullOrWhiteSpace(plc.Role) ? plc.Role : "Êú™Ë®≠ÂÆö")</span>
                                    </div>
                                    <div class="plc-row">
                                        <span class="plc-label">IP„Ç¢„Éâ„É¨„Çπ:</span>
                                        <span class="plc-value">@(!string.IsNullOrWhiteSpace(plc.IpAddress) ? plc.IpAddress : "Êú™Ë®≠ÂÆö")</span>
                                    </div>
                                    <div class="plc-row files-row">
                                        <div>
                                            <div class="plc-label">„Ç≥„É°„É≥„Éà„Éï„Ç°„Ç§„É´</div>
                                            <div class="plc-value">@((plc.CommentFile is not null) ? plc.CommentFile.FileName : "Êú™Ë®≠ÂÆö")</div>
                                        </div>
                                        <div>
                                            <div class="plc-label">„Éó„É≠„Ç∞„É©„É†„Éï„Ç°„Ç§„É´</div>
                                            <div class="plc-value">@((plc.ProgramFile is not null) ? plc.ProgramFile.FileName : "Êú™Ë®≠ÂÆö")</div>
                                        </div>
                                    </div>
                                    <div class="plc-row modules-row">
                                        <div class="plc-label">„É¢„Ç∏„É•„Éº„É´</div>
                                        <div class="plc-modules">
                                            @if (plc.Modules.Any())
                                            {
                                                @foreach (var module in plc.Modules)
                                                {
                                                    <span class="plc-chip">@module.Name @if(!string.IsNullOrWhiteSpace(module.Specification)){<text>Ôºà@module.SpecificationÔºâ</text>}</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="plc-value">Êú™Ë®≠ÂÆö</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="drawing-empty">PLC„É¶„Éã„ÉÉ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                    }
                </div>

                <div class="agent-settings-section drawing-manager">
                    <div class="drawing-header">
                        <div>
                            <div class="agent-settings-section-title">Âõ≥Èù¢ÁÆ°ÁêÜ</div>
                            <div class="drawing-subtitle">MXia „ÅÆ„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£Ë®≠ÂÆö„ÇíÂèÇËÄÉ„Å´„Åó„ÅüÂõ≥Èù¢ÁôªÈå≤</div>
                        </div>
                        <button type="button"
                                class="new-chat-btn save-agent-btn drawing-open-btn"
                                @onclick="OpenDrawingModalForCreate"
                                disabled="@(string.IsNullOrWhiteSpace(selectedAgentNumber) || !isAdmin)">
                            Âõ≥Èù¢„ÇíÁôªÈå≤
                        </button>
                    </div>
                    <div class="drawing-permission">ÁÆ°ÁêÜËÄÖ„ÅÆ„Åø‰ΩúÊàê„Å®Á∑®ÈõÜ„ÅåÂèØËÉΩ„Åß„Åô</div>

                    @if (string.IsNullOrWhiteSpace(selectedAgentNumber))
                    {
                        <div class="drawing-empty">Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    }
                    else if (_drawings.Any())
                    {
                        <div class="drawing-list">
                            @foreach (var drawing in _drawings)
                            {
                                <div class="drawing-card">
                                    <div class="drawing-file">
                                        <div class="drawing-file-name">@drawing.FileName</div>
                                        <div class="drawing-meta">
                                            <span>@FormatFileSize(drawing.FileSize)</span>
                                            @if (!string.IsNullOrWhiteSpace(drawing.Description))
                                            {
                                                <span class="drawing-divider">‚Ä¢</span>
                                                <span class="drawing-description">@drawing.Description</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="drawing-actions">
                                        <div class="drawing-updated">Êõ¥Êñ∞ @drawing.UpdatedAt.ToLocalTime().ToString("MM/dd HH:mm")</div>
                                        <button type="button"
                                                class="agent-delete-btn drawing-edit-btn"
                                                disabled="@( !isAdmin)"
                                                @onclick="() => OpenDrawingModalForEdit(drawing)">
                                            Á∑®ÈõÜ
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="drawing-empty">ÁôªÈå≤Ê∏à„Åø„ÅÆÂõ≥Èù¢„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (_drawingModalOpen)
{
    <div class="drawing-modal-overlay" @onclick="CloseDrawingModal">
        <div class="drawing-modal-shell" @onclick:stopPropagation="true">
            <div class="drawing-modal-header">
                <div>
                    <div class="drawing-modal-title">@(_editingDrawingId.HasValue ? "Âõ≥Èù¢„ÇíÁ∑®ÈõÜ" : "Âõ≥Èù¢„ÇíÁôªÈå≤")</div>
                    <div class="drawing-modal-subtitle">Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà @selectedAgentNumber</div>
                </div>
                <button type="button" class="drawing-close" @onclick="CloseDrawingModal" aria-label="Èñâ„Åò„Çã">√ó</button>
            </div>

            <div class="drawing-modal-body">
                @if (!_editingDrawingId.HasValue)
                {
                    <div class="field">
                        <label>Âõ≥Èù¢„Éï„Ç°„Ç§„É´</label>
                        <div class="drawing-dropzone">
                            <InputFile OnChange="OnDrawingFileSelected" accept=".pdf,.png,.jpg,.jpeg,.dwg" />
                            <div class="drawing-drop-label">
                                <div class="drop-primary">Âõ≥Èù¢„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû</div>
                                <div class="drop-secondary">PDF / DWG / PNG / JPG „Å´ÂØæÂøú„ÉªÊúÄÂ§ß10MB</div>
                            </div>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(_selectedDrawingFileName))
                        {
                            <div class="drawing-file-chip">
                                @_selectedDrawingFileName (@FormatFileSize(_selectedDrawingFileSize))
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="field">
                        <label>Âõ≥Èù¢„Éï„Ç°„Ç§„É´</label>
                        <div class="drawing-file-chip">
                            @_selectedDrawingFileName (@FormatFileSize(_selectedDrawingFileSize))
                        </div>
                        <div class="drawing-file-hint">„Éï„Ç°„Ç§„É´Â∑Æ„ÅóÊõø„Åà„ÅØÊñ∞Ë¶èÁôªÈå≤„ÅßÂØæÂøú„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                    </div>
                }

                <div class="field">
                    <label>Ë™¨Êòé</label>
                    <textarea class="agent-input drawing-description"
                              rows="3"
                              placeholder="Âõ≥Èù¢„ÅÆÊ¶ÇË¶Å„ÇÑ„É™„Éì„Ç∏„Éß„É≥„É°„É¢"
                              @bind="_drawingDescription"></textarea>
                </div>

                @if (!string.IsNullOrWhiteSpace(_drawingError))
                {
                    <div class="drawing-error">@_drawingError</div>
                }
            </div>

            <div class="drawing-modal-actions">
                <button type="button" class="agent-delete-btn cancel-btn" @onclick="CloseDrawingModal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button"
                        class="new-chat-btn save-agent-btn drawing-save-btn"
                        disabled="@( !CanSaveDrawing)"
                        @onclick="SaveDrawingAsync">
                    @(_editingDrawingId.HasValue ? "‰øùÂ≠ò" : "ÁôªÈå≤")
                </button>
            </div>
        </div>
    </div>
}

@if (_plcModalOpen)
{
    <div class="drawing-modal-overlay" @onclick="ClosePlcModal">
        <div class="plc-modal-shell" @onclick:stopPropagation="true">
            <div class="drawing-modal-header">
                <div>
                    <div class="drawing-modal-title">@(_editingPlcId.HasValue ? "PLC„É¶„Éã„ÉÉ„ÉàÁ∑®ÈõÜ" : "PLC„É¶„Éã„ÉÉ„ÉàËøΩÂä†")</div>
                    <div class="drawing-modal-subtitle">Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà @selectedAgentNumber</div>
                </div>
                <button type="button" class="drawing-close" @onclick="ClosePlcModal" aria-label="Èñâ„Åò„Çã">√ó</button>
            </div>

            <div class="drawing-modal-body">
                <div class="field">
                    <label>ÂêçÂâç</label>
                    <input class="agent-input" @bind="_plcName" placeholder="‰æã: PLC1" />
                </div>
                <div class="field double">
                    <div>
                        <label>„É¢„Éá„É´</label>
                        <input class="agent-input" @bind="_plcModel" placeholder="‰æã: Q03UDV" />
                    </div>
                    <div>
                        <label>ÂΩπÂâ≤</label>
                        <input class="agent-input" @bind="_plcRole" placeholder="‰æã: „É°„Ç§„É≥Âà∂Âæ°" />
                    </div>
                </div>
                <div class="field">
                    <label>IP„Ç¢„Éâ„É¨„Çπ</label>
                    <input class="agent-input" @bind="_plcIp" placeholder="‰æã: 192.168.0.10" />
                </div>

                <div class="plc-file-group">
                    <div class="plc-file-title">„Ç≥„É°„É≥„Éà„Éï„Ç°„Ç§„É´</div>
                    <div class="plc-file-box">
                        <InputFile OnChange="OnCommentFileSelected" />
                        <div class="plc-file-info">
                            @_commentFileName ?? "„Ç≥„É°„É≥„Éà„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"
                            @if (_commentFileSize > 0)
                            {
                                <span class="plc-file-size">(@FormatFileSize(_commentFileSize))</span>
                            }
                        </div>
                    </div>
                </div>

                    <div class="plc-file-group">
                        <div class="plc-file-title">„Éó„É≠„Ç∞„É©„É†„Éï„Ç°„Ç§„É´</div>
                        <div class="plc-file-box">
                            <InputFile OnChange="OnProgramFileSelected" />
                            <div class="plc-file-info">
                                @_programFileName ?? "„Éó„É≠„Ç∞„É©„É†„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì"
                                @if (_programFileSize > 0)
                                {
                                    <span class="plc-file-size">(@FormatFileSize(_programFileSize))</span>
                                }
                            </div>
                        </div>
                    </div>

                <div class="plc-modules-group">
                    <div class="plc-module-header">
                        <div>
                            <div class="plc-file-title">„É¢„Ç∏„É•„Éº„É´</div>
                            <div class="drawing-subtitle">‰ΩøÁî®„Åó„Å¶„ÅÑ„Çã„É¢„Ç∏„É•„Éº„É´„ÇíËøΩÂä†</div>
                        </div>
                        <button type="button" class="agent-delete-btn drawing-edit-btn" @onclick="AddOrUpdateModule" disabled="@string.IsNullOrWhiteSpace(_moduleNameInput)">
                            @(_editingModuleIndex.HasValue ? "Êõ¥Êñ∞" : "ËøΩÂä†")
                        </button>
                    </div>
                    <div class="field double">
                        <div>
                            <label>Á®ÆÈ°û</label>
                            <input class="agent-input" @bind="_moduleNameInput" placeholder="‰æã: ÂÖ•Âäõ" />
                        </div>
                        <div>
                            <label>‰ªïÊßò</label>
                            <input class="agent-input" @bind="_moduleSpecInput" placeholder="‰æã: 16ÁÇπ" />
                        </div>
                    </div>
                    <div class="plc-module-list">
                        @if (_moduleInputs.Count == 0)
                        {
                            <div class="drawing-empty">„É¢„Ç∏„É•„Éº„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        }
                        else
                        {
                            @for (var i = 0; i < _moduleInputs.Count; i++)
                            {
                                var module = _moduleInputs[i];
                                <div class="plc-module-row">
                                    <div class="plc-module-name">@module.Name @if(!string.IsNullOrWhiteSpace(module.Specification)){<text>Ôºà@module.SpecificationÔºâ</text>}</div>
                                    <div class="plc-actions">
                                        <button type="button" class="agent-delete-btn drawing-edit-btn" @onclick="() => EditModule(i)">Á∑®ÈõÜ</button>
                                        <button type="button" class="agent-delete-btn danger-btn" @onclick="() => RemoveModule(i)">ÂâäÈô§</button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(_plcError))
                {
                    <div class="drawing-error">@_plcError</div>
                }
            </div>

            <div class="drawing-modal-actions">
                <button type="button" class="agent-delete-btn cancel-btn" @onclick="ClosePlcModal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button"
                        class="new-chat-btn save-agent-btn drawing-save-btn"
                        disabled="@(!CanSavePlc)"
                        @onclick="SavePlcAsync">
                    ‰øùÂ≠ò
                </button>
            </div>
        </div>
    </div>
}

@if (_userSettingsOpen)
{
    <div class="user-settings-overlay" @onclick="CloseUserSettings">
        <div class="user-settings-shell" @onclick:stopPropagation="true">
            <div class="user-settings-sidebar">
                <div class="user-settings-sidebar-header">
                    <span class="user-settings-sidebar-title">Ë®≠ÂÆö</span>
                    <button type="button" class="user-settings-close" title="Èñâ„Åò„Çã" @onclick="CloseUserSettings">√ó</button>
                </div>
                <button type="button"
                        class="user-settings-nav @(_selectedAction == UserAction.Theme ? "active" : string.Empty)"
                        @onclick="() => SelectAction(UserAction.Theme)">
                    <span class="icon">üé®</span>
                    <span>„ÉÜ„Éº„Éû</span>
                </button>
                <button type="button"
                        class="user-settings-nav @(_selectedAction == UserAction.Logout ? "active" : string.Empty)"
                        @onclick="() => SelectAction(UserAction.Logout)">
                    <span class="icon">üîí</span>
                    <span>„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
                </button>
            </div>
            <div class="user-settings-content">
                @if (_selectedAction == UserAction.Theme)
                {
                    <div class="user-settings-section">
                        <div class="user-settings-title-row">
                            <div>
                                <div class="user-settings-title">Â§ñË¶≥</div>
                                <div class="user-settings-subtitle">„ÉÜ„Éº„Éû„Ç´„É©„Éº„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åô</div>
                            </div>
                        </div>
                        <div class="user-settings-row">
                            <div>
                                <div class="user-settings-label">„ÉÜ„Éº„Éû</div>
                                <div class="user-settings-helper">„É©„Ç§„Éà/„ÉÄ„Éº„ÇØ„ÇíÈÅ∏Êäû</div>
                            </div>
                            <select class="user-settings-select" @bind="_selectedTheme">
                                <option value="@Theme.Light">„É©„Ç§„Éà</option>
                                <option value="@Theme.Dark">„ÉÄ„Éº„ÇØ</option>
                            </select>
                        </div>
                        <div class="user-settings-actions">
                            <button type="button" class="user-settings-save" @onclick="SaveUserSettingsAsync">‰øùÂ≠ò</button>
                        </div>
                    </div>
                }
                else if (_selectedAction == UserAction.Logout)
                {
                    <div class="user-settings-section">
                        <div class="user-settings-title-row">
                            <div>
                                <div class="user-settings-title">„É≠„Ç∞„Ç¢„Ç¶„Éà</div>
                                <div class="user-settings-subtitle">„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô</div>
                            </div>
                        </div>
                        <div class="user-settings-row logout-row">
                            <div>
                                <div class="user-settings-label">ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº</div>
                                <div class="user-settings-helper">@_userId</div>
                            </div>
                            <div class="user-settings-actions inline">
                                <button type="button" class="user-settings-save danger" @onclick="ConfirmLogout">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsCollapsed { get; set; }
    [Parameter] public EventCallback OnToggle { get; set; }

    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private string userName = "„É¶„Éº„Ç∂„Éº";
    private string userInitial = "U";
    private string? _userId;
    private bool _loaded;
    private bool _settingsOpen; // „Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫„Éï„É©„Ç∞
    private bool _userSettingsOpen;
    private UserAction _selectedAction = UserAction.Theme;
    private bool isAdmin;
    private bool isDeveloper;
    private string selectedAgentNumber = string.Empty;
    private string selectedAgentName = string.Empty;
    private string agentNumberInput = string.Empty;
    private string agentNameInput = string.Empty;
    private bool _isRegistering;
    private Theme _selectedTheme = Theme.Light;
    private IReadOnlyList<DrawingDocument> _drawings = Array.Empty<DrawingDocument>();
    private bool _drawingModalOpen;
    private Guid? _editingDrawingId;
    private string _drawingDescription = string.Empty;
    private IBrowserFile? _drawingFile;
    private string _selectedDrawingFileName = string.Empty;
    private long _selectedDrawingFileSize;
    private string? _drawingError;
    private bool _drawingSaving;
    private IReadOnlyList<PlcUnit> _plcUnits = Array.Empty<PlcUnit>();
    private bool _plcModalOpen;
    private Guid? _editingPlcId;
    private string _plcName = string.Empty;
    private string _plcModel = string.Empty;
    private string _plcRole = string.Empty;
    private string _plcIp = string.Empty;
    private IBrowserFile? _programFile;
    private IBrowserFile? _commentFile;
    private string? _programFileName;
    private long _programFileSize;
    private string? _commentFileName;
    private long _commentFileSize;
    private List<PlcModuleDraft> _moduleInputs = new();
    private int? _editingModuleIndex;
    private string? _plcError;
    private bool _plcSaving;
    private string _moduleNameInput = string.Empty;
    private string _moduleSpecInput = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        HistoryState.Changed += OnHistoryChanged;
        AgentState.Changed += OnAgentStateChanged;
        PreferencesState.Changed += OnPreferencesChanged;
        await EnsureHistoryAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsurePreferencesAsync();
        }
    }

    private Task ToggleAsync() => OnToggle.InvokeAsync();

    private void StartNewChat()
    {
        NavigationManager.NavigateTo("/", forceLoad: true);
    }

    private void NavigateToRoles()
    {
        NavigationManager.NavigateTo("/settings/roles");
    }

    private async Task EnsureHistoryAsync()
    {
        if (_loaded)
        {
            return;
        }

        var authState = await AuthenticationStateTask;
        var principal = authState.User;
        _userId = principal.FindFirst("oid")?.Value
                  ?? principal.FindFirst(ClaimTypes.NameIdentifier)?.Value
                  ?? principal.Identity?.Name
                  ?? "anonymous";
        userName = principal.Identity?.Name
                   ?? principal.FindFirst("name")?.Value
                   ?? "„É¶„Éº„Ç∂„Éº";
        userInitial = string.IsNullOrWhiteSpace(userName)
            ? "U"
            : userName[..1].ToUpperInvariant();
        isAdmin = await RoleProvider.IsInRoleAsync(_userId, UserRoleId.Predefined.Administrator.Value);
        isDeveloper = await RoleProvider.IsInRoleAsync(_userId, UserRoleId.Predefined.Developer.Value);

        await AgentState.LoadAsync(_userId);
        selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
        selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
        await HistoryState.LoadAsync(_userId, AgentState.SelectedAgentNumber);
        await LoadDrawingsAsync();
        await LoadPlcUnitsAsync();
        _loaded = true;
    }

    private async Task EnsurePreferencesAsync()
    {
        await PreferencesState.LoadAsync();
        _selectedTheme = PreferencesState.Preferences.Theme;
    }

    private void OnHistoryChanged() => InvokeAsync(StateHasChanged);

    private void OpenConversation(string conversationId)
    {
        var uri = NavigationManager.GetUriWithQueryParameter("c", conversationId);
        NavigationManager.NavigateTo(uri, forceLoad: true);
    }

    private async Task OnAgentChanged(ChangeEventArgs e)
    {
        if (_userId is null)
        {
            return;
        }

        var number = e.Value?.ToString();
        number = string.IsNullOrWhiteSpace(number) ? null : number;
        AgentState.Select(number);
        selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
        selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
        await LoadDrawingsAsync();
        await LoadPlcUnitsAsync();
    }

    private void OnAgentStateChanged()
    {
        _ = InvokeAsync(async () =>
        {
            selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
            selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
            if (_userId is not null)
            {
                await HistoryState.LoadAsync(_userId, AgentState.SelectedAgentNumber);
                await LoadDrawingsAsync();
                await LoadPlcUnitsAsync();
            }
            StateHasChanged();
        });
    }

    private void ToggleSettings()
    {
        if (!CanManageAgents)
        {
            return;
        }

        _settingsOpen = !_settingsOpen;
        if (!_settingsOpen)
        {
            ClearAgentInputs();
        }
    }

    private void OpenUserActions()
    {
        _selectedAction = UserAction.Theme;
        _selectedTheme = PreferencesState.Preferences.Theme;
        _userSettingsOpen = true;
    }

    private void CloseUserSettings()
    {
        _userSettingsOpen = false;
    }

    private void SelectAction(UserAction action)
    {
        _selectedAction = action;
    }

    private void ConfirmLogout()
    {
        NavigationManager.NavigateTo("/logout?confirm=true", forceLoad: true);
    }

    private bool CanManageAgents => isAdmin || isDeveloper;

    private async Task SaveUserSettingsAsync()
    {
        await PreferencesState.UpdateThemeAsync(_selectedTheme);
        _userSettingsOpen = false;
    }

    private async Task RegisterAgentAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(agentNumberInput) || string.IsNullOrWhiteSpace(agentNameInput))
        {
            return;
        }

        _isRegistering = true;
        try
        {
            await AgentState.AddOrUpdateAsync(_userId, agentNumberInput.Trim(), agentNameInput.Trim());
            ClearAgentInputs();
            _settingsOpen = false;
        }
        finally
        {
            _isRegistering = false;
        }
    }

    private async Task ConfirmDeleteAgentAsync(DeviceAgentProfile agent)
    {
        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"„Ç®„Éº„Ç∏„Çß„É≥„Éà„Äå{agent.Number} - {agent.Name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü");

        if (!confirmed)
        {
            return;
        }

        await AgentState.RemoveAsync(_userId, agent.Number);
        selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
        selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
        await HistoryState.LoadAsync(_userId, AgentState.SelectedAgentNumber);
        StateHasChanged();
    }

    private void CloseOverlay()
    {
        _settingsOpen = false;
        ClearAgentInputs();
    }

    private void ClearAgentInputs()
    {
        agentNumberInput = string.Empty;
        agentNameInput = string.Empty;
    }

    private async Task LoadDrawingsAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(selectedAgentNumber))
        {
            _drawings = Array.Empty<DrawingDocument>();
            return;
        }

        _drawings = await DrawingService.ListAsync(_userId, selectedAgentNumber);
    }

    private async Task LoadPlcUnitsAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(selectedAgentNumber))
        {
            _plcUnits = Array.Empty<PlcUnit>();
            return;
        }

        _plcUnits = await PlcService.ListAsync(_userId, selectedAgentNumber);
    }

    private async Task OpenDrawingModalForCreate()
    {
        if (!isAdmin)
        {
            await JsRuntime.InvokeVoidAsync("alert", "ÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂõ≥Èù¢„ÇíÁôªÈå≤„Åß„Åç„Åæ„Åô");
            return;
        }

        if (string.IsNullOrWhiteSpace(selectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            return;
        }

        _editingDrawingId = null;
        _drawingDescription = string.Empty;
        _drawingFile = null;
        _selectedDrawingFileName = string.Empty;
        _selectedDrawingFileSize = 0;
        _drawingError = null;
        _drawingModalOpen = true;
    }

    private async Task OpenDrawingModalForEdit(DrawingDocument drawing)
    {
        if (!isAdmin)
        {
            await JsRuntime.InvokeVoidAsync("alert", "ÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂõ≥Èù¢„ÇíÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô");
            return;
        }

        _editingDrawingId = drawing.Id;
        _drawingDescription = drawing.Description ?? string.Empty;
        _selectedDrawingFileName = drawing.FileName;
        _selectedDrawingFileSize = drawing.FileSize;
        _drawingFile = null;
        _drawingError = null;
        _drawingModalOpen = true;
    }

    private void CloseDrawingModal()
    {
        _drawingModalOpen = false;
        _editingDrawingId = null;
        _drawingDescription = string.Empty;
        _drawingFile = null;
        _selectedDrawingFileName = string.Empty;
        _selectedDrawingFileSize = 0;
        _drawingError = null;
    }

    private async Task OnDrawingFileSelected(InputFileChangeEventArgs args)
    {
        var file = args.File;
        _drawingFile = file;
        _selectedDrawingFileName = Path.GetFileName(file.Name);
        _selectedDrawingFileSize = file.Size;
        _drawingError = null;
        await InvokeAsync(StateHasChanged);
    }

    private async Task SaveDrawingAsync()
    {
        if (_userId is null)
        {
            return;
        }

        _drawingError = null;

        if (!isAdmin)
        {
            _drawingError = "ÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂõ≥Èù¢„ÇíÁôªÈå≤„Åß„Åç„Åæ„Åô";
            return;
        }

        if (string.IsNullOrWhiteSpace(selectedAgentNumber))
        {
            _drawingError = "Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
            return;
        }

        _drawingSaving = true;
        try
        {
            DrawingRegistrationResult result;
            if (_editingDrawingId.HasValue)
            {
                result = await DrawingService.UpdateDescriptionAsync(_userId, _editingDrawingId.Value, _drawingDescription);
            }
            else
            {
                if (_drawingFile is null)
                {
                    _drawingError = "Âõ≥Èù¢„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
                    return;
                }

                var upload = new DrawingUpload
                {
                    FileName = _selectedDrawingFileName,
                    ContentType = _drawingFile.ContentType,
                    FileSize = _selectedDrawingFileSize,
                    Description = _drawingDescription
                };

                result = await DrawingService.RegisterAsync(_userId, selectedAgentNumber, upload);
            }

            if (!result.Succeeded)
            {
                _drawingError = result.Error;
                return;
            }

            await LoadDrawingsAsync();
            CloseDrawingModal();
        }
        finally
        {
            _drawingSaving = false;
        }
    }

    private bool CanSaveDrawing => !_drawingSaving
                                   && isAdmin
                                   && !string.IsNullOrWhiteSpace(selectedAgentNumber)
                                   && (_editingDrawingId.HasValue || _drawingFile is not null);

    private async Task OpenPlcModalForCreate()
    {
        if (string.IsNullOrWhiteSpace(selectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            return;
        }

        _editingPlcId = null;
        _plcName = string.Empty;
        _plcModel = string.Empty;
        _plcRole = string.Empty;
        _plcIp = string.Empty;
        _programFile = null;
        _commentFile = null;
        _programFileName = null;
        _commentFileName = null;
        _programFileSize = 0;
        _commentFileSize = 0;
        _moduleInputs.Clear();
        ResetModuleInput();
        _plcError = null;
        _plcModalOpen = true;
    }

    private async Task OpenPlcModalForEdit(PlcUnit unit)
    {
        if (string.IsNullOrWhiteSpace(selectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            return;
        }

        _editingPlcId = unit.Id;
        _plcName = unit.Name;
        _plcModel = unit.Model ?? string.Empty;
        _plcRole = unit.Role ?? string.Empty;
        _plcIp = unit.IpAddress ?? string.Empty;
        _programFile = null;
        _commentFile = null;
        _programFileName = unit.ProgramFile?.FileName;
        _programFileSize = unit.ProgramFile?.FileSize ?? 0;
        _commentFileName = unit.CommentFile?.FileName;
        _commentFileSize = unit.CommentFile?.FileSize ?? 0;
        _moduleInputs = unit.Modules
            .Select(m => new PlcModuleDraft { Name = m.Name, Specification = m.Specification })
            .ToList();
        ResetModuleInput();
        _plcError = null;
        _plcModalOpen = true;
    }

    private void ClosePlcModal()
    {
        _plcModalOpen = false;
        _editingPlcId = null;
        ResetModuleInput();
    }

    private async Task OnProgramFileSelected(InputFileChangeEventArgs args)
    {
        var file = args.File;
        _programFile = file;
        _programFileName = Path.GetFileName(file.Name);
        _programFileSize = file.Size;
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnCommentFileSelected(InputFileChangeEventArgs args)
    {
        var file = args.File;
        _commentFile = file;
        _commentFileName = Path.GetFileName(file.Name);
        _commentFileSize = file.Size;
        await InvokeAsync(StateHasChanged);
    }

    private void AddOrUpdateModule()
    {
        if (string.IsNullOrWhiteSpace(_moduleNameInput))
        {
            return;
        }

        var draft = new PlcModuleDraft
        {
            Name = _moduleNameInput,
            Specification = _moduleSpecInput
        };

        if (_editingModuleIndex.HasValue && _editingModuleIndex.Value >= 0 && _editingModuleIndex.Value < _moduleInputs.Count)
        {
            _moduleInputs[_editingModuleIndex.Value] = draft;
        }
        else
        {
            _moduleInputs.Add(draft);
        }

        ResetModuleInput();
    }

    private void EditModule(int index)
    {
        if (index < 0 || index >= _moduleInputs.Count)
        {
            return;
        }

        var module = _moduleInputs[index];
        _moduleNameInput = module.Name;
        _moduleSpecInput = module.Specification ?? string.Empty;
        _editingModuleIndex = index;
    }

    private void RemoveModule(int index)
    {
        if (index < 0 || index >= _moduleInputs.Count)
        {
            return;
        }

        _moduleInputs.RemoveAt(index);
        ResetModuleInput();
    }

    private async Task SavePlcAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(selectedAgentNumber))
        {
            _plcError = "Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
            return;
        }

        _plcError = null;
        _plcSaving = true;
        try
        {
            var draft = new PlcUnitDraft
            {
                Name = _plcName,
                Model = _plcModel,
                Role = _plcRole,
                IpAddress = _plcIp,
                Modules = _moduleInputs.ToList(),
                CommentFile = _commentFile is not null
                    ? new PlcFileUpload
                    {
                        FileName = _commentFileName ?? string.Empty,
                        ContentType = _commentFile.ContentType,
                        FileSize = _commentFileSize
                    }
                    : null,
                ProgramFile = _programFile is not null
                    ? new PlcFileUpload
                    {
                        FileName = _programFileName ?? string.Empty,
                        ContentType = _programFile.ContentType,
                        FileSize = _programFileSize
                    }
                    : null
            };

            PlcUnitResult result;
            if (_editingPlcId.HasValue)
            {
                result = await PlcService.UpdateAsync(_userId, selectedAgentNumber, _editingPlcId.Value, draft);
            }
            else
            {
                result = await PlcService.AddAsync(_userId, selectedAgentNumber, draft);
            }

            if (!result.Succeeded)
            {
                _plcError = result.Error;
                return;
            }

            await LoadPlcUnitsAsync();
            ClosePlcModal();
        }
        finally
        {
            _plcSaving = false;
        }
    }

    private async Task DeletePlcUnitAsync(PlcUnit unit)
    {
        if (_userId is null || string.IsNullOrWhiteSpace(selectedAgentNumber))
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"„Äå{unit.Name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü");

        if (!confirmed)
        {
            return;
        }

        var deleted = await PlcService.DeleteAsync(_userId, selectedAgentNumber, unit.Id);
        if (deleted)
        {
            await LoadPlcUnitsAsync();
        }
    }

    private void ResetModuleInput()
    {
        _moduleNameInput = string.Empty;
        _moduleSpecInput = string.Empty;
        _editingModuleIndex = null;
    }

    private bool CanSavePlc => !_plcSaving
                               && !string.IsNullOrWhiteSpace(selectedAgentNumber)
                               && !string.IsNullOrWhiteSpace(_plcName);

    private static string FormatFileSize(long size)
    {
        const double kilo = 1024d;
        const double mega = kilo * 1024d;

        if (size >= mega)
        {
            return $"{size / mega:0.0} MB";
        }

        if (size >= kilo)
        {
            return $"{size / kilo:0.0} KB";
        }

        return $"{size} B";
    }

    private async Task ConfirmDeleteAsync(ConversationSummary summary)
    {
        if (!_loaded)
        {
            await EnsureHistoryAsync();
        }

        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"„Äå{summary.Title}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü");

        if (!confirmed)
        {
            return;
        }

        await HistoryState.DeleteAsync(_userId, summary.Id, AgentState.SelectedAgentNumber);

        if (NavigationManager.Uri.Contains($"c={summary.Id}", StringComparison.Ordinal))
        {
            NavigationManager.NavigateTo("/", forceLoad: true);
        }
    }

    private void OnPreferencesChanged()
    {
        _ = InvokeAsync(() =>
        {
            _selectedTheme = PreferencesState.Preferences.Theme;
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    public void Dispose()
    {
        HistoryState.Changed -= OnHistoryChanged;
        AgentState.Changed -= OnAgentStateChanged;
        PreferencesState.Changed -= OnPreferencesChanged;
    }

    private enum UserAction
    {
        Theme,
        Logout
    }
}
