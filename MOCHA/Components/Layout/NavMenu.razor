@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavigationManager
@inject MOCHA.Services.Chat.ConversationHistoryState HistoryState
@inherits LayoutComponentBase
@implements IDisposable

<div class="sidebar-container @(IsCollapsed ? "collapsed" : string.Empty)">
    <div class="sidebar-header">
        <div class="sidebar-title">
            <img src="icon.png" alt="Chat" class="sidebar-title-icon" />
            <span class="sr-only">Chat</span>
        </div>
        <button class="new-chat-btn" @onclick="StartNewChat">New Chat</button>
        <button class="sidebar-toggle" type="button" @onclick="ToggleAsync" title="サイドバー切替">
            @(IsCollapsed ? "›" : "‹")
        </button>
    </div>

    <div class="sessions-list">
        @if (HistoryState.Summaries.Any())
        {
            @foreach (var item in HistoryState.Summaries.OrderByDescending(h => h.UpdatedAt))
            {
                <div class="session-item" @onclick="() => OpenConversation(item.Id)">
                    <div class="session-content">
                        <div class="history-title">@item.Title</div>
                        <div class="history-time">@item.UpdatedAt.ToLocalTime().ToString("MM/dd HH:mm")</div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="history-empty">履歴がありません</div>
        }
    </div>

    <div class="user-info">
        <div class="user-avatar">@userInitial</div>
        <div>
            <div class="user-name">@userName</div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsCollapsed { get; set; }
    [Parameter] public EventCallback OnToggle { get; set; }

    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private string userName = "ユーザー";
    private string userInitial = "U";
    private string? _userId;
    private bool _loaded;

    protected override async Task OnInitializedAsync()
    {
        HistoryState.Changed += OnHistoryChanged;
        await EnsureHistoryAsync();
    }

    private Task ToggleAsync() => OnToggle.InvokeAsync();

    private void StartNewChat()
    {
        NavigationManager.NavigateTo("/", forceLoad: true);
    }

    private async Task EnsureHistoryAsync()
    {
        if (_loaded)
        {
            return;
        }

        var authState = await AuthenticationStateTask;
        var principal = authState.User;
        _userId = principal.FindFirst("oid")?.Value
                  ?? principal.FindFirst(ClaimTypes.NameIdentifier)?.Value
                  ?? principal.Identity?.Name
                  ?? "anonymous";
        userName = principal.Identity?.Name
                   ?? principal.FindFirst("name")?.Value
                   ?? "ユーザー";
        userInitial = string.IsNullOrWhiteSpace(userName)
            ? "U"
            : userName[..1].ToUpperInvariant();

        await HistoryState.LoadAsync(_userId);
        _loaded = true;
    }

    private void OnHistoryChanged() => InvokeAsync(StateHasChanged);

    private void OpenConversation(string conversationId)
    {
        var uri = NavigationManager.GetUriWithQueryParameter("c", conversationId);
        NavigationManager.NavigateTo(uri, forceLoad: true);
    }

    public void Dispose()
    {
        HistoryState.Changed -= OnHistoryChanged;
    }
}
