@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using MOCHA.Models.Chat
@using MOCHA.Models.Agents
@using MOCHA.Models.Settings
@using MOCHA.Models.Auth
@inject NavigationManager NavigationManager
@inject MOCHA.Services.Chat.ConversationHistoryState HistoryState
@inject MOCHA.Services.Agents.DeviceAgentState AgentState
@inject MOCHA.Services.Settings.UserPreferencesState PreferencesState
@inject IUserRoleProvider RoleProvider
@inject IJSRuntime JsRuntime
@inherits LayoutComponentBase
@implements IDisposable

<div class="sidebar-container @(IsCollapsed ? "collapsed" : string.Empty)">
    <div class="sidebar-header">
    <div class="sidebar-title">
        <img src="icon.png" alt="Chat" class="sidebar-title-icon" />
        @if (isAdmin)
        {
            <button type="button" class="sidebar-admin-btn" title="„É≠„Éº„É´ÁÆ°ÁêÜ" @onclick="NavigateToRoles">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M12 4.5c1.4 0 2.8.5 3.9 1.5l1.1-1.1a.6.6 0 0 1 1 0l2.1 2.1a.6.6 0 0 1 0 1l-1.1 1.1a6 6 0 0 1 0 3.9l1.1 1.1a.6.6 0 0 1 0 1l-2.1 2.1a.6.6 0 0 1-1 0l-1.1-1.1a6 6 0 0 1-3.9 0l-1.1 1.1a.6.6 0 0 1-1 0l-2.1-2.1a.6.6 0 0 1 0-1l1.1-1.1a6 6 0 0 1 0-3.9L7 8a.6.6 0 0 1 0-1l2.1-2.1a.6.6 0 0 1 1 0l1.1 1.1a6 6 0 0 1 3.9-1.5ZM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6Z" stroke="currentColor" stroke-width="1.4" fill="none" />
                </svg>
                <span class="sr-only">„É≠„Éº„É´ÁÆ°ÁêÜ</span>
            </button>
        }
        <span class="sr-only">Chat</span>
    </div>
        <button class="new-chat-btn" @onclick="StartNewChat">New Chat</button>
        <button class="sidebar-toggle" type="button" @onclick="ToggleAsync" title="„Çµ„Ç§„Éâ„Éê„ÉºÂàáÊõø">
            @(IsCollapsed ? "‚Ä∫" : "‚Äπ")
        </button>
    </div>

    <div class="agent-section">
        <div class="agent-label">Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà</div>
        <div class="agent-select-row">
            <select class="agent-select" value="@selectedAgentNumber" @onchange="OnAgentChanged">
                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                @foreach (var agent in AgentState.Agents.OrderBy(a => a.Number))
                {
                    <option value="@agent.Number">@agent.Name - @agent.Number</option>
                }
            </select>
            <button type="button" class="agent-gear-btn" title="„Ç®„Éº„Ç∏„Çß„É≥„ÉàË®≠ÂÆö" @onclick="ToggleSettings">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.5" fill="none" />
                    <path d="M19.4 13.5a7.9 7.9 0 0 0 0-3l1.9-1.5a.7.7 0 0 0 .2-.8l-1.8-3.1a.7.7 0 0 0-.8-.3l-2.2.9a8.4 8.4 0 0 0-2.6-1.5l-.3-2.3a.7.7 0 0 0-.7-.6h-3.6a.7.7 0 0 0-.7.6L8.8 3.9a8.4 8.4 0 0 0-2.6 1.5l-2.2-.9a.7.7 0 0 0-.8.3L1.4 8a.7.7 0 0 0 .2.8l1.9 1.5a7.9 7.9 0 0 0 0 3l-1.9 1.5a.7.7 0 0 0-.2.8l1.8 3.1c.2.3.5.4.8.3l2.2-.9a8.4 8.4 0 0 0 2.6 1.5l.3 2.3c0 .3.3.6.7.6h3.6c.4 0 .7-.3.7-.6l.3-2.3a8.4 8.4 0 0 0 2.6-1.5l2.2.9c.3.1.6 0 .8-.3l1.8-3.1a.7.7 0 0 0-.2-.8l-1.9-1.5Z" stroke="currentColor" stroke-width="1.5" fill="none" />
                </svg>
            </button>
        </div>
        <div class="agent-note">
            @if (!string.IsNullOrWhiteSpace(selectedAgentName))
            {
                <span>@selectedAgentName</span>
            }
            else
            {
                <span class="agent-warning">Êú™ÈÅ∏Êäû</span>
            }
        </div>
    </div>

    <div class="sessions-list">
        @if (HistoryState.Summaries.Any())
        {
            @foreach (var item in HistoryState.Summaries.OrderByDescending(h => h.UpdatedAt))
            {
                <div class="session-item" @onclick="() => OpenConversation(item.Id)">
                    <div class="session-content">
                        <div class="history-title">@item.Title</div>
                        <div class="history-time">@item.UpdatedAt.ToLocalTime().ToString("MM/dd HH:mm")</div>
                    </div>
                    <button type="button"
                            class="session-menu-btn"
                            title="Â±•Ê≠¥„ÇíÂâäÈô§"
                            aria-label="Â±•Ê≠¥„ÇíÂâäÈô§"
                            @onclick:stopPropagation="true"
                            @onclick="() => ConfirmDeleteAsync(item)">
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <path d="M9 3.5h6m-9 3h12M10 10.5v7m4-7v7M5.5 6.5l1 13a1 1 0 0 0 1 .92h9a1 1 0 0 0 1-.92l1-13" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                            <path d="M9 4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                        </svg>
                    </button>
                </div>
            }
        }
        else
        {
            <div class="history-empty">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
        }
    </div>

<button type="button" class="user-info" @onclick="OpenUserActions" title="„É¶„Éº„Ç∂„ÉºË®≠ÂÆö">
    <div class="user-avatar">@userInitial</div>
    <div>
        <div class="user-name">@userName</div>
    </div>
</button>
</div>

@if (_settingsOpen)
{
    <div class="agent-settings-overlay" @onclick="CloseOverlay">
        <div class="agent-settings-dialog" @onclick:stopPropagation="true">
            <div class="agent-settings-header">
                <div>
                    <div class="agent-settings-title">Ë£ÖÁΩÆ„Ç®„Éº„Ç∏„Çß„É≥„ÉàË®≠ÂÆö</div>
                    <div class="agent-settings-subtitle">ÁôªÈå≤„ÉªÂâäÈô§„ÇÑ‰ªäÂæå„ÅÆË®≠ÂÆöÊã°Âºµ„Çí„Åæ„Å®„ÇÅ„Å¶ÁÆ°ÁêÜ„Åó„Åæ„Åô</div>
                </div>
                <button type="button" class="agent-settings-close" title="Èñâ„Åò„Çã" @onclick="CloseOverlay">
                    √ó
                </button>
            </div>

            <div class="agent-settings-body">
                <div class="agent-settings-section">
                    <div class="field">
                        <label for="agent-name">ÂêçÂâç</label>
                        <input id="agent-name"
                               class="agent-input"
                               @bind="agentNameInput"
                               placeholder="Ë£ÖÁΩÆÂêç„Å™„Å©" />
                    </div>
                    <div class="field">
                        <label for="agent-number">Áï™Âè∑</label>
                        <input id="agent-number"
                               class="agent-input"
                               @bind="agentNumberInput"
                               placeholder="‰æã: A-01" />
                    </div>
                    <button class="new-chat-btn save-agent-btn"
                            @onclick="RegisterAgentAsync"
                            disabled="@(_isRegistering || string.IsNullOrWhiteSpace(agentNumberInput) || string.IsNullOrWhiteSpace(agentNameInput))">
                        ÁôªÈå≤
                    </button>
                </div>

                <div class="agent-settings-section">
                    <div class="agent-settings-section-title">ÁôªÈå≤Ê∏à„Åø„Ç®„Éº„Ç∏„Çß„É≥„Éà</div>
                    <div class="agent-list">
                        @if (AgentState.Agents.Any())
                        {
                            @foreach (var agent in AgentState.Agents.OrderBy(a => a.Number))
                            {
                                <div class="agent-row">
                                    <div class="agent-row-info">
                                        <div class="agent-row-name">@agent.Name</div>
                                        <div class="agent-row-number">@agent.Number</div>
                                    </div>
                                    <button type="button"
                                            class="agent-delete-btn"
                                            title="„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÂâäÈô§"
                                            @onclick="() => ConfirmDeleteAgentAsync(agent)">
                                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                            <path d="M9 3.5h6m-9 3h12M10 10.5v7m4-7v7M5.5 6.5l1 13a1 1 0 0 0 1 .92h9a1 1 0 0 0 1-.92l1-13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                                            <path d="M9 4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                                        </svg>
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="agent-list-empty">„Ç®„Éº„Ç∏„Çß„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (_userSettingsOpen)
{
    <div class="user-settings-overlay" @onclick="CloseUserSettings">
        <div class="user-settings-shell" @onclick:stopPropagation="true">
            <div class="user-settings-sidebar">
                <div class="user-settings-sidebar-header">
                    <span class="user-settings-sidebar-title">Ë®≠ÂÆö</span>
                    <button type="button" class="user-settings-close" title="Èñâ„Åò„Çã" @onclick="CloseUserSettings">√ó</button>
                </div>
                <button type="button"
                        class="user-settings-nav @(_selectedAction == UserAction.Theme ? "active" : string.Empty)"
                        @onclick="() => SelectAction(UserAction.Theme)">
                    <span class="icon">üé®</span>
                    <span>„ÉÜ„Éº„Éû</span>
                </button>
                <button type="button"
                        class="user-settings-nav @(_selectedAction == UserAction.Logout ? "active" : string.Empty)"
                        @onclick="() => SelectAction(UserAction.Logout)">
                    <span class="icon">üîí</span>
                    <span>„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
                </button>
            </div>
            <div class="user-settings-content">
                @if (_selectedAction == UserAction.Theme)
                {
                    <div class="user-settings-section">
                        <div class="user-settings-title-row">
                            <div>
                                <div class="user-settings-title">Â§ñË¶≥</div>
                                <div class="user-settings-subtitle">„ÉÜ„Éº„Éû„Ç´„É©„Éº„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åô</div>
                            </div>
                        </div>
                        <div class="user-settings-row">
                            <div>
                                <div class="user-settings-label">„ÉÜ„Éº„Éû</div>
                                <div class="user-settings-helper">„É©„Ç§„Éà/„ÉÄ„Éº„ÇØ„ÇíÈÅ∏Êäû</div>
                            </div>
                            <select class="user-settings-select" @bind="_selectedTheme">
                                <option value="@Theme.Light">„É©„Ç§„Éà</option>
                                <option value="@Theme.Dark">„ÉÄ„Éº„ÇØ</option>
                            </select>
                        </div>
                        <div class="user-settings-actions">
                            <button type="button" class="user-settings-save" @onclick="SaveUserSettingsAsync">‰øùÂ≠ò</button>
                        </div>
                    </div>
                }
                else if (_selectedAction == UserAction.Logout)
                {
                    <div class="user-settings-section">
                        <div class="user-settings-title-row">
                            <div>
                                <div class="user-settings-title">„É≠„Ç∞„Ç¢„Ç¶„Éà</div>
                                <div class="user-settings-subtitle">„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô</div>
                            </div>
                        </div>
                        <div class="user-settings-row logout-row">
                            <div>
                                <div class="user-settings-label">ÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº</div>
                                <div class="user-settings-helper">@_userId</div>
                            </div>
                            <div class="user-settings-actions inline">
                                <button type="button" class="user-settings-save danger" @onclick="ConfirmLogout">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsCollapsed { get; set; }
    [Parameter] public EventCallback OnToggle { get; set; }

    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private string userName = "„É¶„Éº„Ç∂„Éº";
    private string userInitial = "U";
    private string? _userId;
    private bool _loaded;
    private bool _settingsOpen; // „Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫„Éï„É©„Ç∞
    private bool _userSettingsOpen;
    private UserAction _selectedAction = UserAction.Theme;
    private bool isAdmin;
    private string selectedAgentNumber = string.Empty;
    private string selectedAgentName = string.Empty;
    private string agentNumberInput = string.Empty;
    private string agentNameInput = string.Empty;
    private bool _isRegistering;
    private Theme _selectedTheme = Theme.Light;

    protected override async Task OnInitializedAsync()
    {
        HistoryState.Changed += OnHistoryChanged;
        AgentState.Changed += OnAgentStateChanged;
        PreferencesState.Changed += OnPreferencesChanged;
        await EnsureHistoryAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsurePreferencesAsync();
        }
    }

    private Task ToggleAsync() => OnToggle.InvokeAsync();

    private void StartNewChat()
    {
        NavigationManager.NavigateTo("/", forceLoad: true);
    }

    private void NavigateToRoles()
    {
        NavigationManager.NavigateTo("/settings/roles");
    }

    private async Task EnsureHistoryAsync()
    {
        if (_loaded)
        {
            return;
        }

        var authState = await AuthenticationStateTask;
        var principal = authState.User;
        _userId = principal.FindFirst("oid")?.Value
                  ?? principal.FindFirst(ClaimTypes.NameIdentifier)?.Value
                  ?? principal.Identity?.Name
                  ?? "anonymous";
        userName = principal.Identity?.Name
                   ?? principal.FindFirst("name")?.Value
                   ?? "„É¶„Éº„Ç∂„Éº";
        userInitial = string.IsNullOrWhiteSpace(userName)
            ? "U"
            : userName[..1].ToUpperInvariant();
        isAdmin = await RoleProvider.IsInRoleAsync(_userId, UserRoleId.Predefined.Administrator.Value);

        await AgentState.LoadAsync(_userId);
        selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
        selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
        await HistoryState.LoadAsync(_userId, AgentState.SelectedAgentNumber);
        _loaded = true;
    }

    private async Task EnsurePreferencesAsync()
    {
        await PreferencesState.LoadAsync();
        _selectedTheme = PreferencesState.Preferences.Theme;
    }

    private void OnHistoryChanged() => InvokeAsync(StateHasChanged);

    private void OpenConversation(string conversationId)
    {
        var uri = NavigationManager.GetUriWithQueryParameter("c", conversationId);
        NavigationManager.NavigateTo(uri, forceLoad: true);
    }

    private async Task OnAgentChanged(ChangeEventArgs e)
    {
        if (_userId is null)
        {
            return;
        }

        var number = e.Value?.ToString();
        number = string.IsNullOrWhiteSpace(number) ? null : number;
        AgentState.Select(number);
        selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
        selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
    }

    private void OnAgentStateChanged()
    {
        _ = InvokeAsync(async () =>
        {
            selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
            selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
            if (_userId is not null)
            {
                await HistoryState.LoadAsync(_userId, AgentState.SelectedAgentNumber);
            }
            StateHasChanged();
        });
    }

    private void ToggleSettings()
    {
        _settingsOpen = !_settingsOpen;
        if (!_settingsOpen)
        {
            ClearAgentInputs();
        }
    }

    private void OpenUserActions()
    {
        _selectedAction = UserAction.Theme;
        _selectedTheme = PreferencesState.Preferences.Theme;
        _userSettingsOpen = true;
    }

    private void CloseUserSettings()
    {
        _userSettingsOpen = false;
    }

    private void SelectAction(UserAction action)
    {
        _selectedAction = action;
    }

    private void ConfirmLogout()
    {
        NavigationManager.NavigateTo("/logout?confirm=true", forceLoad: true);
    }

    private async Task SaveUserSettingsAsync()
    {
        await PreferencesState.UpdateThemeAsync(_selectedTheme);
        _userSettingsOpen = false;
    }

    private async Task RegisterAgentAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(agentNumberInput) || string.IsNullOrWhiteSpace(agentNameInput))
        {
            return;
        }

        _isRegistering = true;
        try
        {
            await AgentState.AddOrUpdateAsync(_userId, agentNumberInput.Trim(), agentNameInput.Trim());
            ClearAgentInputs();
            _settingsOpen = false;
        }
        finally
        {
            _isRegistering = false;
        }
    }

    private async Task ConfirmDeleteAgentAsync(DeviceAgentProfile agent)
    {
        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"„Ç®„Éº„Ç∏„Çß„É≥„Éà„Äå{agent.Number} - {agent.Name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü");

        if (!confirmed)
        {
            return;
        }

        await AgentState.RemoveAsync(_userId, agent.Number);
        selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
        selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
        await HistoryState.LoadAsync(_userId, AgentState.SelectedAgentNumber);
        StateHasChanged();
    }

    private void CloseOverlay()
    {
        _settingsOpen = false;
        ClearAgentInputs();
    }

    private void ClearAgentInputs()
    {
        agentNumberInput = string.Empty;
        agentNameInput = string.Empty;
    }

    private async Task ConfirmDeleteAsync(ConversationSummary summary)
    {
        if (!_loaded)
        {
            await EnsureHistoryAsync();
        }

        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"„Äå{summary.Title}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü");

        if (!confirmed)
        {
            return;
        }

        await HistoryState.DeleteAsync(_userId, summary.Id, AgentState.SelectedAgentNumber);

        if (NavigationManager.Uri.Contains($"c={summary.Id}", StringComparison.Ordinal))
        {
            NavigationManager.NavigateTo("/", forceLoad: true);
        }
    }

    private void OnPreferencesChanged()
    {
        _ = InvokeAsync(() =>
        {
            _selectedTheme = PreferencesState.Preferences.Theme;
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    public void Dispose()
    {
        HistoryState.Changed -= OnHistoryChanged;
        AgentState.Changed -= OnAgentStateChanged;
        PreferencesState.Changed -= OnPreferencesChanged;
    }

    private enum UserAction
    {
        Theme,
        Logout
    }
}
