@using System
@using System.Linq
@using System.Security.Claims
@using System.Threading
@using MOCHA.Services.Agents
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.IO
@using MOCHA.Models.Chat
@using MOCHA.Models.Agents
@using MOCHA.Models.Settings
@using MOCHA.Models.Auth
@using MOCHA.Models.Drawings
@using MOCHA.Models.Architecture
@using MOCHA.Services.Architecture
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager NavigationManager
@inject MOCHA.Services.Chat.ConversationHistoryState HistoryState
@inject MOCHA.Services.Agents.DeviceAgentState AgentState
@inject MOCHA.Services.Settings.UserPreferencesState PreferencesState
@inject IUserRoleProvider RoleProvider
@inject MOCHA.Services.Drawings.DrawingRegistrationService DrawingService
@inject MOCHA.Services.Architecture.PlcConfigurationService PlcService
@inject PcConfigurationService PcConfigurationService
@inject UnitConfigurationService UnitConfigurationService
@inject FunctionBlockService FunctionBlockService
@inject IJSRuntime JsRuntime
@inherits LayoutComponentBase
@implements IDisposable

<div class="sidebar-container @(IsCollapsed ? "collapsed" : string.Empty)">
    <div class="sidebar-header">
        <div class="sidebar-title">
            <img src="icon.png" alt="Chat" class="sidebar-title-icon" />
            @if (isAdmin)
            {
                <button type="button" class="sidebar-admin-btn" title="ロール管理" @onclick="NavigateToRoles">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M12 3.2 5 6v5.3c0 4 3 7.5 7 8.5 4-1 7-4.5 7-8.5V6l-7-2.8Z" stroke="currentColor" stroke-width="1.4" fill="none" />
                        <path d="M12 12.2a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z" stroke="currentColor" stroke-width="1.4" fill="none" />
                        <path d="M8.8 16.1c.5-1.2 1.8-2.1 3.2-2.1s2.7.9 3.2 2.1" stroke="currentColor" stroke-width="1.4" fill="none" stroke-linecap="round" />
                    </svg>
                    <span class="sr-only">ロール管理</span>
                </button>
            }
            <span class="sr-only">Chat</span>
        </div>
        <button class="new-chat-btn" @onclick="StartNewChat">New Chat</button>
        <button class="sidebar-toggle" type="button" @onclick="ToggleAsync" title="サイドバー切替">
            @(IsCollapsed ? "›" : "‹")
        </button>
    </div>

    <div class="agent-section">
        <div class="agent-label">装置エージェント</div>
        <div class="agent-select-row">
            <select class="agent-select" value="@selectedAgentNumber" @onchange="OnAgentChanged">
                <option value="">選択してください</option>
                @foreach (var agent in AgentState.Agents.OrderBy(a => a.Number))
                {
                    <option value="@agent.Number">@agent.Name - @agent.Number</option>
                }
            </select>
            @if (CanManageAgents)
            {
                <button type="button" class="agent-gear-btn" title="エージェント設定" @onclick="ToggleSettings">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.5" fill="none" />
                        <path d="M19.4 13.5a7.9 7.9 0 0 0 0-3l1.9-1.5a.7.7 0 0 0 .2-.8l-1.8-3.1a.7.7 0 0 0-.8-.3l-2.2.9a8.4 8.4 0 0 0-2.6-1.5l-.3-2.3a.7.7 0 0 0-.7-.6h-3.6a.7.7 0 0 0-.7.6L8.8 3.9a8.4 8.4 0 0 0-2.6 1.5l-2.2-.9a.7.7 0 0 0-.8.3L1.4 8a.7.7 0 0 0 .2.8l1.9 1.5a7.9 7.9 0 0 0 0 3l-1.9 1.5a.7.7 0 0 0-.2.8l1.8 3.1c.2.3.5.4.8.3l2.2-.9a8.4 8.4 0 0 0 2.6 1.5l.3 2.3c0 .3.3.6.7.6h3.6c.4 0 .7-.3.7-.6l.3-2.3a8.4 8.4 0 0 0 2.6-1.5l2.2.9c.3.1.6 0 .8-.3l1.8-3.1a.7.7 0 0 0-.2-.8l-1.9-1.5Z" stroke="currentColor" stroke-width="1.5" fill="none" />
                    </svg>
                </button>
            }
        </div>
    </div>

    <div class="sessions-list">
        @if (HistoryState.Summaries.Any())
        {
            @foreach (var item in HistoryState.Summaries.OrderByDescending(h => h.UpdatedAt))
            {
                <div class="session-item" @onclick="() => OpenConversation(item.Id)">
                    <div class="session-content">
                        <div class="history-title">@(!string.IsNullOrWhiteSpace(item.Title) ? item.Title : "タイトル生成中…")</div>
                        <div class="history-time">@item.UpdatedAt.ToLocalTime().ToString("MM/dd HH:mm")</div>
                    </div>
                    <button type="button"
                            class="session-menu-btn"
                            title="履歴を削除"
                            aria-label="履歴を削除"
                            @onclick:stopPropagation="true"
                            @onclick="() => ConfirmDeleteAsync(item)">
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <path d="M9 3.5h6m-9 3h12M10 10.5v7m4-7v7M5.5 6.5l1 13a1 1 0 0 0 1 .92h9a1 1 0 0 0 1-.92l1-13" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                            <path d="M9 4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                        </svg>
                    </button>
                </div>
            }
        }
        else
        {
            <div class="history-empty">履歴がありません</div>
        }
    </div>

<button type="button" class="user-info" @onclick="OpenUserActions" title="ユーザー設定">
    <div class="user-avatar">@userInitial</div>
    <div>
        <div class="user-name">@userName</div>
    </div>
</button>
</div>

@if (_settingsOpen)
{
    <div class="agent-settings-overlay" @onclick="CloseOverlay">
        <div class="agent-settings-dialog" @onclick:stopPropagation="true">
            <div class="agent-settings-header">
                <div>
                    <div class="agent-settings-title">装置エージェント設定</div>
                    <div class="agent-settings-subtitle">登録・削除や今後の設定拡張をまとめて管理します</div>
                </div>
                <button type="button" class="agent-settings-close" title="閉じる" @onclick="CloseOverlay">
                    ×
                </button>
            </div>

            <div class="agent-settings-body">
                <div class="agent-settings-grid">
                    <div class="agent-settings-sidebar" role="tablist" aria-label="装置エージェント設定切り替え">
                        <button type="button"
                                class="agent-nav @(_agentSettingsTab == AgentSettingsTab.Register ? "active" : string.Empty)"
                                role="tab"
                                aria-selected="@(_agentSettingsTab == AgentSettingsTab.Register)"
                                @onclick="() => SelectAgentSettingsTab(AgentSettingsTab.Register)">
                            <span class="agent-nav-title">登録</span>
                            <span class="agent-nav-subtitle">新規エージェントを追加</span>
                        </button>
                        <button type="button"
                                class="agent-nav @(_agentSettingsTab == AgentSettingsTab.List ? "active" : string.Empty)"
                                role="tab"
                                aria-selected="@(_agentSettingsTab == AgentSettingsTab.List)"
                                @onclick="() => SelectAgentSettingsTab(AgentSettingsTab.List)">
                            <span class="agent-nav-title">登録済み</span>
                            <span class="agent-nav-subtitle">登録内容の確認・削除</span>
                        </button>
                    </div>

                    <div class="agent-settings-main">
                        @if (_agentSettingsTab == AgentSettingsTab.Register)
                        {
                            <div class="agent-panel" role="tabpanel">
                                <div class="agent-settings">
                                    <div class="field">
                                        <label for="agent-name">名前</label>
                                        <input id="agent-name"
                                               class="agent-input"
                                               @bind="agentNameInput"
                                               placeholder="装置名など" />
                                    </div>
                                    <div class="field">
                                        <label for="agent-number">番号</label>
                                        <input id="agent-number"
                                               class="agent-input"
                                               @bind="agentNumberInput"
                                               placeholder="例: A-01" />
                                    </div>
                                    <button class="new-chat-btn save-agent-btn"
                                            @onclick="RegisterAgentAsync"
                                            disabled="@(_isRegistering || string.IsNullOrWhiteSpace(agentNumberInput) || string.IsNullOrWhiteSpace(agentNameInput))">
                                        登録
                                    </button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="agent-panel" role="tabpanel">
                                <div class="agent-settings-section-title">登録済みエージェント</div>
                                <div class="agent-list">
                                    @if (AgentState.Agents.Any())
                                    {
                                        @foreach (var agent in AgentState.Agents.OrderBy(a => a.Number))
                                        {
                                            var isSelected = IsSettingsSelected(agent.Number);
                                            <div class="agent-row @(isSelected ? "selected" : string.Empty)">
                                                <button type="button"
                                                        class="agent-row-main"
                                                        aria-pressed="@isSelected"
                                                        @onclick="() => SelectSettingsAgent(agent)">
                                                    <span class="agent-radio">
                                                        <span class="agent-radio-dot @(isSelected ? "active" : string.Empty)"></span>
                                                    </span>
                                                    <div class="agent-row-info">
                                                        <div class="agent-row-name">@agent.Name</div>
                                                        <div class="agent-row-number">@agent.Number</div>
                                                    </div>
                                                </button>
                                                <button type="button"
                                                        class="agent-delete-btn"
                                                        title="エージェントを削除"
                                                        @onclick="() => ConfirmDeleteAgentAsync(agent)">
                                                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                                        <path d="M9 3.5h6m-9 3h12M10 10.5v7m4-7v7M5.5 6.5l1 13a1 1 0 0 0 1 .92h9a1 1 0 0 0 1-.92l1-13" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                                                        <path d="M9 4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                                                    </svg>
                                                </button>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="agent-list-empty">エージェントがありません</div>
                                    }
                                </div>
                            </div>
                        }

                        <div class="agent-settings-section architecture-manager">
                            <div class="drawing-header">
                                <div>
                                    <div class="agent-settings-section-title">アーキテクチャ設定</div>
                                    <div class="agent-settings-subtitle">PCとPLCの構成をまとめて管理</div>
                                </div>
                                <div class="architecture-actions">
                                    <button type="button"
                                            class="new-chat-btn save-agent-btn drawing-open-btn"
                                            @onclick="OpenUnitModalForCreate"
                                            disabled="@(string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))">
                                        装置ユニットを追加
                                    </button>
                                    <button type="button"
                                            class="new-chat-btn save-agent-btn drawing-open-btn"
                                            @onclick="OpenPlcModalForCreate"
                                            disabled="@(string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))">
                                        PLCユニットを追加
                                    </button>
                                    <button type="button"
                                            class="new-chat-btn save-agent-btn drawing-open-btn"
                                            @onclick="OpenPcModalForCreate"
                                            disabled="@(string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))">
                                        PCを追加
                                    </button>
                                </div>
                            </div>

                            @if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
                            {
                                <div class="drawing-empty">装置エージェントを選択してください</div>
                            }
                            else
                            {
                                <div class="plc-list unit-list">
                                    @if (_unitConfigurations.Any())
                                    {
                                        @foreach (var unit in _unitConfigurations)
                                        {
                                            <div class="plc-card pc-card">
                                                <div class="plc-title-row">
                                                    <div>
                                                        <div class="plc-name">@unit.Name</div>
                                                        <div class="plc-meta">@(!string.IsNullOrWhiteSpace(unit.Description) ? unit.Description : "説明なし")</div>
                                                    </div>
                                                    <div class="plc-actions">
                                                        <button type="button"
                                                                class="agent-delete-btn drawing-edit-btn"
                                                                @onclick="() => OpenUnitModalForEdit(unit)">
                                                            編集
                                                        </button>
                                                        <button type="button"
                                                                class="agent-delete-btn danger-btn"
                                                                @onclick="() => DeleteUnitConfigurationAsync(unit)">
                                                            削除
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="plc-row modules-row">
                                                    <div class="plc-label">機器</div>
                                                    <div class="plc-modules">
                                                        @if (unit.Devices.Any())
                                                        {
                                                            @foreach (var device in unit.Devices)
                                                            {
                                                                <span class="plc-chip">
                                                                    @device.Name
                                                                    @if (!string.IsNullOrWhiteSpace(device.Model))
                                                                    {
                                                                        <text>（@device.Model）</text>
                                                                    }
                                                                    @if (!string.IsNullOrWhiteSpace(device.Maker))
                                                                    {
                                                                        <text> @device.Maker</text>
                                                                    }
                                                                </span>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <span class="plc-value">未設定</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="drawing-empty">装置ユニット構成がありません</div>
                                    }
                                </div>

                                @if (_plcUnits.Any())
                                {
                                    <div class="plc-list">
                                        @foreach (var plc in _plcUnits)
                                        {
                                            <div class="plc-card">
                                                <div class="plc-title-row">
                                                    <div>
                                                        <div class="plc-name">@plc.Name</div>
                                                        <div class="plc-meta">メーカー: @(!string.IsNullOrWhiteSpace(plc.Manufacturer) ? plc.Manufacturer : "未設定")</div>
                                                        <div class="plc-meta">@(!string.IsNullOrWhiteSpace(plc.Model) ? plc.Model : "未設定")</div>
                                                    </div>
                                                    <div class="plc-actions">
                                                        <button type="button"
                                                                class="agent-delete-btn drawing-edit-btn"
                                                                @onclick="() => OpenPlcModalForEdit(plc)">
                                                            編集
                                                        </button>
                                                        <button type="button"
                                                                class="agent-delete-btn danger-btn"
                                                                @onclick="() => DeletePlcUnitAsync(plc)">
                                                            削除
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="plc-row">
                                                    <span class="plc-label">役割:</span>
                                                    <span class="plc-value">@(!string.IsNullOrWhiteSpace(plc.Role) ? plc.Role : "未設定")</span>
                                                </div>
                                                <div class="plc-row endpoint-row">
                                                    <div class="endpoint-cell">
                                                        <div class="plc-label">IPアドレス</div>
                                                        <div class="plc-value">@(!string.IsNullOrWhiteSpace(plc.IpAddress) ? plc.IpAddress : "未設定")</div>
                                                    </div>
                                                    <div class="endpoint-cell">
                                                        <div class="plc-label">ポート</div>
                                                        <div class="plc-value">@FormatPort(plc.Port)</div>
                                                    </div>
                                                </div>
                                                <div class="plc-row files-row">
                                                    <div>
                                                        <div class="plc-label">コメントファイル</div>
                                                        <div class="plc-value">@DisplayFileName(plc.CommentFile?.FileName)</div>
                                                    </div>
                                                    <div>
                                                        <div class="plc-label">プログラムファイル</div>
                                                        <div class="plc-program-list">
                                                            @if (plc.ProgramFiles?.Any() ?? false)
                                                            {
                                                                var programNames = plc.ProgramFiles!.ToList();
                                                                var take = programNames.Take(2).ToList();
                                                                foreach (var file in take)
                                                                {
                                                                    <span class="plc-chip">@DisplayFileName(file.FileName, file.DisplayName)</span>
                                                                }
                                                                if (programNames.Count > 2)
                                                                {
                                                                    <span class="plc-chip muted">+@((programNames.Count - 2)) 件</span>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                <span class="plc-value">未設定</span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="plc-row modules-row">
                                                    <div class="plc-label">ユニット</div>
                                                    <div class="plc-modules">
                                                        @if (plc.Modules.Any())
                                                        {
                                                        @foreach (var unitItem in plc.Modules)
                                                        {
                                                            <span class="plc-chip">@unitItem.Name @if(!string.IsNullOrWhiteSpace(unitItem.Specification)){<text>（@unitItem.Specification）</text>}</span>
                                                        }
                                                        }
                                                        else
                                                        {
                                                            <span class="plc-value">未設定</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="drawing-empty">PLCユニットがありません</div>
                                }

                                <div class="plc-list pc-list">
                                    @if (_pcSettings.Any())
                                    {
                                        @foreach (var pc in _pcSettings)
                                        {
                                            <div class="plc-card pc-card">
                                                <div class="plc-title-row">
                                                    <div>
                                                        <div class="plc-name">@pc.Os</div>
                                                        <div class="plc-meta">役割: @(!string.IsNullOrWhiteSpace(pc.Role) ? pc.Role : "未設定")</div>
                                                    </div>
                                                    <div class="plc-actions">
                                                        <button type="button"
                                                                class="agent-delete-btn drawing-edit-btn"
                                                                @onclick="() => OpenPcModalForEdit(pc)">
                                                            編集
                                                        </button>
                                                        <button type="button"
                                                                class="agent-delete-btn danger-btn"
                                                                @onclick="() => DeletePcSettingAsync(pc)">
                                                            削除
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="plc-row modules-row">
                                                    <div class="plc-label">リポジトリ</div>
                                                    <div class="plc-modules">
                                                        @if (pc.RepositoryUrls?.Any() ?? false)
                                                        {
                                                            @foreach (var url in pc.RepositoryUrls)
                                                            {
                                                                <span class="plc-chip repo-chip">@url</span>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <span class="plc-value">未設定</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="drawing-empty">PC設定がありません</div>
                                    }
                                </div>
                            }
                        </div>

                        <div class="agent-settings-section drawing-manager">
                            <div class="drawing-header">
                                <div>
                                    <div class="agent-settings-section-title">図面管理</div>
                                </div>
                                <button type="button"
                                        class="new-chat-btn save-agent-btn drawing-open-btn"
                                        @onclick="OpenDrawingModalForCreate"
                                        disabled="@(string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber) || !isAdmin)">
                                    図面を登録
                                </button>
                            </div>

                            @if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
                            {
                                <div class="drawing-empty">装置エージェントを選択してください</div>
                            }
                            else if (_drawings.Any())
                            {
                                <div class="drawing-list">
                                    @foreach (var drawing in _drawings)
                                    {
                                        <div class="drawing-card">
                                            <div class="drawing-file">
                                                <div class="drawing-file-name">@drawing.FileName</div>
                                                <div class="drawing-meta">
                                                    <span>@FormatFileSize(drawing.FileSize)</span>
                                                    <span class="drawing-divider">•</span>
                                                    <span class="drawing-updated">更新 @drawing.UpdatedAt.ToLocalTime().ToString("MM/dd HH:mm")</span>
                                                    @if (!string.IsNullOrWhiteSpace(drawing.Description))
                                                    {
                                                        <span class="drawing-divider">•</span>
                                                        <span class="drawing-description">@drawing.Description</span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="drawing-actions">
                                                <div class="drawing-action-buttons">
                                                    <button type="button"
                                                            class="agent-delete-btn drawing-edit-btn"
                                                            disabled="@( !isAdmin)"
                                                            @onclick="() => OpenDrawingModalForEdit(drawing)">
                                                        編集
                                                    </button>
                                                    <button type="button"
                                                            class="agent-delete-btn danger-btn"
                                                            disabled="@( !isAdmin)"
                                                            @onclick="() => DeleteDrawingAsync(drawing)">
                                                        削除
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="drawing-empty">登録済みの図面がありません</div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@if (_drawingModalOpen)
{
    <div class="drawing-modal-overlay" @onclick="CloseDrawingModal">
        <div class="drawing-modal-shell" @onclick:stopPropagation="true">
            <div class="drawing-modal-header">
                <div>
                    <div class="drawing-modal-title">@(_editingDrawingId.HasValue ? "図面を編集" : "図面を登録")</div>
                    <div class="drawing-modal-subtitle">装置エージェント @SettingsSelectedAgentNumber</div>
                </div>
                <button type="button" class="drawing-close" @onclick="CloseDrawingModal" aria-label="閉じる">×</button>
            </div>

            <div class="drawing-modal-body">
                @if (!_editingDrawingId.HasValue)
                {
                    <div class="field">
                        <label>図面ファイル</label>
                        <label class="plc-file-box drawing-dropzone" for="drawingFileInput">
                            <div class="plc-file-trigger">
                                <span class="plc-file-icon drawing-drop-icon">⬆</span>
                                <div class="drawing-drop-text">
                                    <div class="drop-primary">図面ファイルを追加</div>
                                    <div class="drop-secondary">PDF / PNG / JPG ・ 複数選択・最大10MB/件</div>
                                </div>
                            </div>
                            <div class="drawing-drop-pill">クリックまたはドロップで選択</div>
                        </label>
                        <InputFile id="drawingFileInput"
                                   Multiple="true"
                                   OnChange="OnDrawingFilesSelected"
                                   accept=".pdf,.png,.jpg,.jpeg"
                                   class="plc-file-input drawing-file-input"
                                   hidden />
                        <div class="program-file-list">
                            @if (_drawingFiles.Count == 0)
                            {
                                <div class="drawing-empty">図面ファイルを選択してください</div>
                            }
                            else
                            {
                                @foreach (var file in _drawingFiles)
                                {
                                    <div class="program-file-row">
                                        <div class="program-file-meta">
                                            <div class="program-file-name">@file.FileName</div>
                                            <div class="program-file-size">@FormatFileSize(file.FileSize)</div>
                                        </div>
                                        <div class="plc-actions">
                                            <button type="button"
                                                    class="plc-module-action-btn danger-btn"
                                                    @onclick="() => RemoveDrawingFile(file.Id)">
                                                削除
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="field">
                        <label>図面ファイル</label>
                        <div class="drawing-file-chip">
                            @_selectedDrawingFileName (@FormatFileSize(_selectedDrawingFileSize))
                        </div>
                        <div class="drawing-file-hint">ファイル差し替えは新規登録で対応してください</div>
                    </div>
                }

                <div class="field">
                    <label>説明</label>
                    <textarea class="agent-input drawing-description"
                              rows="3"
                              placeholder="図面の概要やリビジョンメモ"
                              @bind="_drawingDescription"></textarea>
                </div>

                @if (!string.IsNullOrWhiteSpace(_drawingError))
                {
                    <div class="drawing-error">@_drawingError</div>
                }
            </div>

            <div class="drawing-modal-actions">
                <button type="button" class="agent-delete-btn cancel-btn" @onclick="CloseDrawingModal">キャンセル</button>
                <button type="button"
                        class="new-chat-btn save-agent-btn drawing-save-btn"
                        disabled="@( !CanSaveDrawing)"
                        @onclick="SaveDrawingAsync">
                    @(_editingDrawingId.HasValue ? "保存" : "登録")
                </button>
            </div>
        </div>
    </div>
}

@if (_pcModalOpen)
{
    <div class="drawing-modal-overlay" @onclick="ClosePcModal">
        <div class="pc-modal-shell" @onclick:stopPropagation="true">
            <div class="drawing-modal-header">
                <div>
                    <div class="drawing-modal-title">@(_editingPcId.HasValue ? "PC設定を編集" : "PC設定を登録")</div>
                    <div class="drawing-modal-subtitle">装置エージェント @SettingsSelectedAgentNumber</div>
                </div>
                <button type="button" class="drawing-close" @onclick="ClosePcModal" aria-label="閉じる">×</button>
            </div>

            <div class="drawing-modal-body">
                <div class="field">
                    <label>OS<span class="required-mark" aria-label="必須">*</span></label>
                    <input class="agent-input" @bind="_pcOs" placeholder="例: Windows 11 / Ubuntu" />
                </div>
                <div class="field">
                    <label>役割</label>
                    <input class="agent-input" @bind="_pcRole" placeholder="例: HMI / CI サーバー" />
                </div>
                <div class="field">
                    <label>リポジトリURL</label>
                    <div class="repo-input-row">
                        <input class="agent-input"
                               @bind="_repoInput"
                               placeholder="https://example.com/repo.git"
                               @onkeydown="HandleRepoKeyDown" />
                        <button type="button"
                                class="plc-module-action-btn drawing-edit-btn"
                                @onclick="AddRepositoryUrl">
                            追加
                        </button>
                    </div>
                    <div class="repo-chip-list">
                        @if (_repoUrls.Count == 0)
                        {
                            <span class="plc-value">未設定</span>
                        }
                        else
                        {
                            @foreach (var url in _repoUrls)
                            {
                                <span class="plc-chip repo-chip">
                                    @url
                                    <button type="button" class="repo-remove-btn" @onclick="() => RemoveRepositoryUrl(url)">×</button>
                                </span>
                            }
                        }
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(_pcError))
                {
                    <div class="drawing-error">@_pcError</div>
                }
            </div>

            <div class="drawing-modal-actions">
                <button type="button" class="agent-delete-btn cancel-btn" @onclick="ClosePcModal">キャンセル</button>
                <button type="button"
                        class="new-chat-btn save-agent-btn drawing-save-btn"
                        disabled="@( !CanSavePc)"
                        @onclick="SavePcAsync">
                    @(_editingPcId.HasValue ? "保存" : "登録")
                </button>
            </div>
        </div>
    </div>
}

@if (_unitModalOpen)
{
    <div class="drawing-modal-overlay" @onclick="CloseUnitModal">
        <div class="pc-modal-shell" @onclick:stopPropagation="true">
            <div class="drawing-modal-header">
                <div>
                    <div class="drawing-modal-title">@(_editingUnitId.HasValue ? "装置ユニットを編集" : "装置ユニットを追加")</div>
                    <div class="drawing-modal-subtitle">装置エージェント @SettingsSelectedAgentNumber</div>
                </div>
                <button type="button" class="drawing-close" @onclick="CloseUnitModal" aria-label="閉じる">×</button>
            </div>

            <div class="drawing-modal-body">
                <div class="field">
                    <label>ユニット名<span class="required-mark" aria-label="必須">*</span></label>
                    <input class="agent-input" @bind="_unitName" placeholder="例: ライン1-前段" />
                </div>
                <div class="field">
                    <label>ユニット説明</label>
                    <textarea class="agent-input drawing-description"
                              rows="2"
                              placeholder="ユニットの概要や役割"
                              @bind="_unitDescription"></textarea>
                </div>

                <div class="plc-program-group">
                    <div class="plc-module-header">
                        <div>
                            <div class="plc-file-title">構成機器</div>
                            <div class="drawing-subtitle">名称は必須。型式・メーカー・説明は任意</div>
                        </div>
                        <button type="button" class="plc-module-add-btn program-add-btn" @onclick="AddUnitDeviceRow">追加</button>
                    </div>
                    <div class="unit-device-list">
                        @if (_unitDeviceInputs.Count == 0)
                        {
                            <div class="drawing-empty">機器を追加してください</div>
                        }
                        else
                        {
                            @foreach (var device in _unitDeviceInputs)
                            {
                                <div class="unit-device-row" @key="device.Id">
                                    <div class="field">
                                        <label>名称<span class="required-mark" aria-label="必須">*</span></label>
                                        <input class="agent-input" @bind="device.Name" placeholder="例: 搬送機" />
                                    </div>
                                    <div class="field">
                                        <label>型式</label>
                                        <input class="agent-input" @bind="device.Model" placeholder="例: XZ-100" />
                                    </div>
                                    <div class="field">
                                        <label>メーカー</label>
                                        <input class="agent-input" @bind="device.Maker" placeholder="例: Contoso" />
                                    </div>
                                    <div class="field">
                                        <label>説明</label>
                                        <input class="agent-input" @bind="device.Description" placeholder="例: 前段搬送用" />
                                    </div>
                                    <button type="button"
                                            class="agent-delete-btn danger-btn unit-device-remove"
                                            title="削除"
                                            @onclick="() => RemoveUnitDeviceRow(device.Id)">
                                        削除
                                    </button>
                                </div>
                            }
                        }
                    </div>
                </div>

                @if (!string.IsNullOrWhiteSpace(_unitError))
                {
                    <div class="drawing-error">@_unitError</div>
                }
            </div>

            <div class="drawing-modal-actions">
                <button type="button" class="agent-delete-btn cancel-btn" @onclick="CloseUnitModal">キャンセル</button>
                <button type="button"
                        class="new-chat-btn save-agent-btn drawing-save-btn"
                        disabled="@( !CanSaveUnit)"
                        @onclick="SaveUnitAsync">
                    @(_editingUnitId.HasValue ? "保存" : "登録")
                </button>
            </div>
        </div>
    </div>
}

@if (_plcModalOpen)
{
    <div class="drawing-modal-overlay" @onclick="ClosePlcModal">
        <div class="plc-modal-shell" @onclick:stopPropagation="true">
            <div class="drawing-modal-header">
                <div>
                    <div class="drawing-modal-title">@(_editingPlcId.HasValue ? "PLCユニット編集" : "PLCユニット追加")</div>
                    <div class="drawing-modal-subtitle">装置エージェント @SettingsSelectedAgentNumber</div>
                </div>
                <button type="button" class="drawing-close" @onclick="ClosePlcModal" aria-label="閉じる">×</button>
            </div>

            <div class="drawing-modal-body">
                <div class="field double">
                    <div>
                        <label>名前<span class="required-mark" aria-label="必須">*</span></label>
                        <input class="agent-input" @bind="_plcName" placeholder="例: PLC1" />
                    </div>
                    <div>
                        <label>メーカー<span class="required-mark" aria-label="必須">*</span></label>
                        <select class="agent-input" @bind="_plcManufacturer">
                            <option value="">選択してください</option>
                            @foreach (var maker in PlcUnitDraft.SupportedManufacturers)
                            {
                                <option value="@maker">@maker</option>
                            }
                        </select>
                    </div>
                </div>
                <div class="field double">
                    <div>
                        <label>モデル</label>
                        <input class="agent-input" @bind="_plcModel" placeholder="例: R08CPU" />
                    </div>
                    <div>
                        <label>役割</label>
                        <input class="agent-input" @bind="_plcRole" placeholder="例: 搬送制御" />
                    </div>
                </div>
                <div class="field double endpoint-fields">
                    <div>
                        <label>IPアドレス<span class="required-mark" aria-label="必須">*</span></label>
                        <input class="agent-input" @bind="_plcIp" placeholder="例: 192.168.0.10" />
                    </div>
                    <div>
                        <label>ポート<span class="required-mark" aria-label="必須">*</span></label>
                        <input class="agent-input"
                               type="number"
                               min="1"
                               max="65535"
                               @bind="_plcPort"
                               placeholder="例: 5000" />
                    </div>
                </div>

                <div class="plc-program-group">
                    <div class="plc-module-header">
                        <div>
                            <div class="plc-file-title">プログラムファイル（複数可）</div>
                            <div class="drawing-subtitle">CSVのみ・最大10MB/件</div>
                        </div>
                        <label class="plc-module-add-btn program-add-btn" for="programFileInput">追加</label>
                    </div>
                    <label class="plc-file-box program-add-box" for="programFileInput">
                        <div class="plc-file-trigger">
                            <span class="plc-file-icon">⬆</span>
                            <div>
                                <div class="plc-file-trigger-main">CSVを追加</div>
                                <div class="plc-file-trigger-sub">複数選択・ドラッグ&ドロップ対応</div>
                            </div>
                        </div>
                        <div class="plc-file-info">
                            @_programFiles.Count 件選択中
                        </div>
                    </label>
                    <InputFile id="programFileInput"
                               Multiple="true"
                               OnChange="OnProgramFilesSelected"
                               accept=".csv,text/csv"
                               class="plc-file-input"
                               hidden />
                    <div class="program-file-list">
                        @if (_programFiles.Count == 0)
                        {
                            <div class="drawing-empty">プログラムファイルがありません</div>
                        }
                        else
                        {
                            @foreach (var file in _programFiles)
                            {
                                <div class="program-file-row">
                                    <div class="program-file-meta">
                                        @if (_editingProgramFileId == file.Id)
                                        {
                                            <input class="agent-input program-name-input"
                                                   @bind="_programDisplayNameInput"
                                                   placeholder="表示名を入力" />
                                        }
                                        else
                                        {
                                            <div class="program-file-name">@DisplayFileName(file.FileName, file.DisplayName)</div>
                                        }
                                        <div class="program-file-size">@FormatFileSize(file.FileSize)</div>
                                    </div>
                                    <div class="plc-actions">
                                        @if (_editingProgramFileId == file.Id)
                                        {
                                            <button type="button" class="plc-module-action-btn drawing-edit-btn" @onclick="SaveProgramFileName">保存</button>
                                            <button type="button" class="plc-module-action-btn cancel-btn" @onclick="CancelEditProgramFile">キャンセル</button>
                                        }
                                        else
                                        {
                                            <button type="button" class="plc-module-action-btn drawing-edit-btn" @onclick="() => BeginEditProgramFile(file)">名称変更</button>
                                        }
                                        <label class="plc-module-action-btn drawing-edit-btn" for="@($"replace-{file.Id}")">置き換え</label>
                                        <InputFile id="@($"replace-{file.Id}")"
                                                   OnChange="args => ReplaceProgramFile(file.Id, args)"
                                                   accept=".csv,text/csv"
                                                   class="plc-file-input"
                                                   hidden />
                                        <button type="button" class="plc-module-action-btn danger-btn" @onclick="() => RemoveProgramFile(file.Id)">削除</button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="plc-file-group">
                    <div class="plc-file-title">コメントファイル</div>
                    <label class="plc-file-box" for="commentFileInput">
                        <div class="plc-file-trigger">
                            <span class="plc-file-icon">⬆</span>
                            <div>
                                <div class="plc-file-trigger-main">CSVを選択</div>
                                <div class="plc-file-trigger-sub">コメント用のCSVファイルをアップロード</div>
                            </div>
                        </div>
                        <div class="plc-file-info">
                            @(string.IsNullOrWhiteSpace(_commentFileName) ? "未選択" : _commentFileName)
                            @if (_commentFileSize > 0)
                            {
                                <span class="plc-file-size">(@FormatFileSize(_commentFileSize))</span>
                            }
                        </div>
                    </label>
                    <InputFile id="commentFileInput"
                               OnChange="OnCommentFileSelected"
                               accept=".csv,text/csv"
                               class="plc-file-input"
                               hidden />
                </div>

                <div class="plc-modules-group">
                    <div class="plc-module-header">
                        <div>
                            <div class="plc-file-title">ユニット</div>
                            <div class="drawing-subtitle">使用しているユニットを追加</div>
                        </div>
                        <button type="button" class="plc-module-add-btn" @onclick="AddOrUpdateUnit" disabled="@string.IsNullOrWhiteSpace(_unitNameInput)">
                            @(_editingUnitIndex.HasValue ? "更新" : "追加")
                        </button>
                    </div>
                    <div class="field double">
                        <div>
                            <label>種類</label>
                            <input class="agent-input" @bind="_unitNameInput" placeholder="例: アナログ" />
                        </div>
                        <div>
                            <label>役割</label>
                            <input class="agent-input" @bind="_unitSpecInput" placeholder="例: センサモニター" />
                        </div>
                    </div>
                    <div class="plc-module-list">
                        @if (_unitInputs.Count == 0)
                        {
                            <div class="drawing-empty">ユニットがありません</div>
                        }
                        else
                        {
                            @for (var i = 0; i < _unitInputs.Count; i++)
                            {
                                var index = i;
                                var unitItem = _unitInputs[index];
                                <div class="plc-module-row">
                                    <div class="plc-module-name">@unitItem.Name @if(!string.IsNullOrWhiteSpace(unitItem.Specification)){<text>（@unitItem.Specification）</text>}</div>
                                    <div class="plc-actions">
                                        <button type="button" class="plc-module-action-btn drawing-edit-btn" @onclick="() => EditUnit(index)">編集</button>
                                        <button type="button" class="plc-module-action-btn danger-btn" @onclick="() => RemoveUnit(index)">削除</button>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="plc-modules-group">
                    <div class="plc-module-header">
                        <div>
                            <div class="plc-file-title">ファンクションブロック</div>
                            <div class="drawing-subtitle">ラベル/プログラムCSVをユニットに紐づけ</div>
                        </div>
                        <div class="plc-actions">
                            <button type="button"
                                    class="plc-module-action-btn drawing-edit-btn"
                                    disabled="@(!_editingPlcId.HasValue || _fbLoading)"
                                    @onclick="LoadFunctionBlocksAsync">
                                再読込
                            </button>
                        </div>
                    </div>

                    @if (!_editingPlcId.HasValue)
                    {
                        <div class="drawing-empty">保存済みのPLCユニット編集時に利用できます</div>
                    }
                    else
                    {
                        <div class="plc-fb-upload">
                            <div class="field">
                                <label>ファンクションブロック名</label>
                                <input class="agent-input" @bind="_fbName" placeholder="例: Start" />
                            </div>
                            <div class="plc-file-group">
                                <div class="plc-file-title">ラベルCSV</div>
                                <label class="plc-file-box" for="fbLabelInput">
                                    <div class="plc-file-trigger">
                                        <span class="plc-file-icon">⬆</span>
                                        <div>
                                            <div class="plc-file-trigger-main">CSVを選択</div>
                                            <div class="plc-file-trigger-sub">コメントラベルを含むCSV</div>
                                        </div>
                                    </div>
                                    <div class="plc-file-info">@(_fbLabelFileName ?? "未選択")</div>
                                </label>
                                <InputFile id="fbLabelInput"
                                           OnChange="OnFunctionBlockLabelSelected"
                                           accept=".csv,text/csv"
                                           class="plc-file-input"
                                           hidden />
                            </div>
                            <div class="plc-file-group">
                                <div class="plc-file-title">プログラムCSV</div>
                                <label class="plc-file-box" for="fbProgramInput">
                                    <div class="plc-file-trigger">
                                        <span class="plc-file-icon">⬆</span>
                                        <div>
                                            <div class="plc-file-trigger-main">CSVを選択</div>
                                            <div class="plc-file-trigger-sub">命令リストを含むCSV</div>
                                        </div>
                                    </div>
                                    <div class="plc-file-info">@(_fbProgramFileName ?? "未選択")</div>
                                </label>
                                <InputFile id="fbProgramInput"
                                           OnChange="OnFunctionBlockProgramSelected"
                                           accept=".csv,text/csv"
                                           class="plc-file-input"
                                           hidden />
                            </div>
                            <div class="plc-actions">
                                <button type="button"
                                        class="plc-module-action-btn drawing-edit-btn"
                                        disabled="@(_fbUploading || string.IsNullOrWhiteSpace(_fbName))"
                                        @onclick="UploadFunctionBlockAsync">
                                    登録
                                </button>
                            </div>
                        </div>

                        <div class="plc-module-list">
                            @if (_fbLoading)
                            {
                                <div class="drawing-empty">読み込み中...</div>
                            }
                            else if (_functionBlocks.Count == 0)
                            {
                                <div class="drawing-empty">登録済みのファンクションブロックがありません</div>
                            }
                            else
                            {
                                @foreach (var fb in _functionBlocks)
                                {
                                    <div class="plc-module-row">
                                        <div class="plc-module-name">
                                            <div class="plc-name">@fb.Name</div>
                                            <div class="plc-meta">更新 @fb.UpdatedAt.ToLocalTime().ToString("MM/dd HH:mm")</div>
                                        </div>
                                        <div class="plc-actions">
                                            <button type="button"
                                                    class="plc-module-action-btn danger-btn"
                                                    @onclick="() => DeleteFunctionBlockAsync(fb)">
                                                削除
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    }

                    @if (!string.IsNullOrWhiteSpace(_fbError))
                    {
                        <div class="drawing-error">@_fbError</div>
                    }
                </div>

                @if (!string.IsNullOrWhiteSpace(_plcError))
                {
                    <div class="drawing-error">@_plcError</div>
                }
            </div>

            <div class="drawing-modal-actions">
                <button type="button" class="agent-delete-btn cancel-btn" @onclick="ClosePlcModal">キャンセル</button>
                <button type="button"
                        class="new-chat-btn save-agent-btn drawing-save-btn"
                        disabled="@(!CanSavePlc)"
                        @onclick="SavePlcAsync">
                    保存
                </button>
            </div>
        </div>
    </div>
}

@if (_userSettingsOpen)
{
    <div class="user-settings-overlay" @onclick="CloseUserSettings">
        <div class="user-settings-shell" @onclick:stopPropagation="true">
            <div class="user-settings-sidebar">
                <div class="user-settings-sidebar-header">
                    <span class="user-settings-sidebar-title">設定</span>
                    <button type="button" class="user-settings-close" title="閉じる" @onclick="CloseUserSettings">×</button>
                </div>
                <button type="button"
                        class="user-settings-nav @(_selectedAction == UserAction.Theme ? "active" : string.Empty)"
                        @onclick="() => SelectAction(UserAction.Theme)">
                    <span>テーマ</span>
                </button>
                <button type="button"
                        class="user-settings-nav @(_selectedAction == UserAction.Logout ? "active" : string.Empty)"
                        @onclick="() => SelectAction(UserAction.Logout)">
                    <span>ログアウト</span>
                </button>
            </div>
            <div class="user-settings-content">
                @if (_selectedAction == UserAction.Theme)
                {
                    <div class="user-settings-section">
                        <div class="user-settings-title-row">
                            <div>
                                <div class="user-settings-title">外観</div>
                                <div class="user-settings-subtitle">テーマカラーを切り替えます</div>
                            </div>
                        </div>
                        <div class="user-settings-row">
                            <div>
                                <div class="user-settings-label">テーマ</div>
                                <div class="user-settings-helper">ライト/ダークを選択</div>
                            </div>
                            <select class="user-settings-select" @bind="_selectedTheme">
                                <option value="@Theme.Light">ライト</option>
                                <option value="@Theme.Dark">ダーク</option>
                            </select>
                        </div>
                        <div class="user-settings-actions">
                            <button type="button" class="user-settings-save" @onclick="SaveUserSettingsAsync">保存</button>
                        </div>
                    </div>
                }
                else if (_selectedAction == UserAction.Logout)
                {
                    <div class="user-settings-section">
                        <div class="user-settings-title-row">
                            <div>
                                <div class="user-settings-title">ログアウト</div>
                                <div class="user-settings-subtitle">セッションを終了します</div>
                            </div>
                        </div>
                        <div class="user-settings-row logout-row">
                            <div>
                                <div class="user-settings-label">現在のユーザー</div>
                                <div class="user-settings-helper">@_userId</div>
                            </div>
                            <div class="user-settings-actions inline">
                                <button type="button" class="user-settings-save danger" @onclick="ConfirmLogout">ログアウト</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsCollapsed { get; set; }
    [Parameter] public EventCallback OnToggle { get; set; }

    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private string userName = "ユーザー";
    private string userInitial = "U";
    private string? _userId;
    private bool _loaded;
    private bool _settingsOpen; // オーバーレイ表示フラグ
    private bool _userSettingsOpen;
    private UserAction _selectedAction = UserAction.Theme;
    private bool isAdmin;
    private bool isDeveloper;
    private string selectedAgentNumber = string.Empty;
    private string selectedAgentName = string.Empty;
    private readonly AgentSettingsSelection _agentSettingsSelection = new();
    private string agentNumberInput = string.Empty;
    private string agentNameInput = string.Empty;
    private bool _isRegistering;
    private AgentSettingsTab _agentSettingsTab = AgentSettingsTab.Register;
    private string SettingsSelectedAgentNumber => _agentSettingsSelection.SelectedAgentNumber ?? string.Empty;
    private Theme _selectedTheme = Theme.Light;
    private IReadOnlyList<DrawingDocument> _drawings = Array.Empty<DrawingDocument>();
    private bool _drawingModalOpen;
    private Guid? _editingDrawingId;
    private string _drawingDescription = string.Empty;
    private List<DrawingFileDraft> _drawingFiles = new();
    private string _selectedDrawingFileName = string.Empty;
    private long _selectedDrawingFileSize;
    private string? _drawingError;
    private bool _drawingSaving;
    private const long _drawingMaxFileSizeBytes = 10 * 1024 * 1024;
    private const long _plcMaxFileSizeBytes = 10 * 1024 * 1024;
    private IReadOnlyList<PcSetting> _pcSettings = Array.Empty<PcSetting>();
    private bool _pcModalOpen;
    private Guid? _editingPcId;
    private string _pcOs = string.Empty;
    private string _pcRole = string.Empty;
    private string _repoInput = string.Empty;
    private List<string> _repoUrls = new();
    private string? _pcError;
    private bool _pcSaving;
    private IReadOnlyList<UnitConfiguration> _unitConfigurations = Array.Empty<UnitConfiguration>();
    private bool _unitModalOpen;
    private Guid? _editingUnitId;
    private string _unitName = string.Empty;
    private string _unitDescription = string.Empty;
    private List<UnitDeviceInput> _unitDeviceInputs = new();
    private string? _unitError;
    private bool _unitSaving;
    private IReadOnlyList<PlcUnit> _plcUnits = Array.Empty<PlcUnit>();
    private bool _plcModalOpen;
    private Guid? _editingPlcId;
    private string _plcName = string.Empty;
    private string _plcManufacturer = string.Empty;
    private string _plcModel = string.Empty;
    private string _plcRole = string.Empty;
    private string _plcIp = string.Empty;
    private int? _plcPort;
    private IBrowserFile? _commentFile;
    private string? _commentFileName;
    private long _commentFileSize;
    private byte[]? _commentFileContent;
    private List<ProgramFileDraft> _programFiles = new();
    private Guid? _editingProgramFileId;
    private string _programDisplayNameInput = string.Empty;
    private List<PlcModuleDraft> _unitInputs = new();
    private int? _editingUnitIndex;
    private string? _plcError;
    private bool _plcSaving;
    private string _unitNameInput = string.Empty;
    private string _unitSpecInput = string.Empty;
    private List<FunctionBlock> _functionBlocks = new();
    private string _fbName = string.Empty;
    private IBrowserFile? _fbLabelFile;
    private IBrowserFile? _fbProgramFile;
    private string? _fbLabelFileName;
    private string? _fbProgramFileName;
    private bool _fbLoading;
    private bool _fbUploading;
    private string? _fbError;

    protected override async Task OnInitializedAsync()
    {
        HistoryState.Changed += OnHistoryChanged;
        AgentState.Changed += OnAgentStateChanged;
        PreferencesState.Changed += OnPreferencesChanged;
        await EnsureHistoryAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsurePreferencesAsync();
        }
    }

    private Task ToggleAsync() => OnToggle.InvokeAsync();

    private void StartNewChat()
    {
        NavigationManager.NavigateTo("/");
    }

    private void NavigateToRoles()
    {
        NavigationManager.NavigateTo("/settings/roles");
    }

    private async Task EnsureHistoryAsync()
    {
        if (_loaded)
        {
            return;
        }

        var authState = await AuthenticationStateTask;
        var principal = authState.User;
        _userId = principal.FindFirst("oid")?.Value
                  ?? principal.FindFirst(ClaimTypes.NameIdentifier)?.Value
                  ?? principal.Identity?.Name
                  ?? "anonymous";
        userName = principal.Identity?.Name
                   ?? principal.FindFirst("name")?.Value
                   ?? "ユーザー";
        userInitial = string.IsNullOrWhiteSpace(userName)
            ? "U"
            : userName[..1].ToUpperInvariant();
        isAdmin = await RoleProvider.IsInRoleAsync(_userId, UserRoleId.Predefined.Administrator.Value);
        isDeveloper = await RoleProvider.IsInRoleAsync(_userId, UserRoleId.Predefined.Developer.Value);

        await AgentState.LoadAsync(_userId);
        selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
        selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
        await HistoryState.LoadAsync(_userId, AgentState.SelectedAgentNumber);
        await EnsureSettingsSelectionAsync();
        _loaded = true;
    }

    private async Task EnsurePreferencesAsync()
    {
        await PreferencesState.LoadAsync();
        _selectedTheme = PreferencesState.Preferences.Theme;
    }

    private void OnHistoryChanged() => InvokeAsync(StateHasChanged);

    private void OpenConversation(string conversationId)
    {
        var uri = NavigationManager.GetUriWithQueryParameter("c", conversationId);
        NavigationManager.NavigateTo(uri);
    }

    private async Task OnAgentChanged(ChangeEventArgs e)
    {
        if (_userId is null)
        {
            return;
        }

        var number = e.Value?.ToString();
        number = string.IsNullOrWhiteSpace(number) ? null : number;
        AgentState.Select(number);
        selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
        selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
        await EnsureSettingsSelectionAsync(number);
    }

    private void OnAgentStateChanged()
    {
        _ = InvokeAsync(async () =>
        {
            selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
            selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
            if (_userId is not null)
            {
                await HistoryState.LoadAsync(_userId, AgentState.SelectedAgentNumber);
                await EnsureSettingsSelectionAsync();
            }
            StateHasChanged();
        });
    }

    private async Task EnsureSettingsSelectionAsync(string? preferredNumber = null)
    {
        var candidate = preferredNumber ?? _agentSettingsSelection.SelectedAgentNumber ?? AgentState.SelectedAgentNumber;
        var changed = _agentSettingsSelection.Reset(AgentState.Agents, candidate);
        if (changed)
        {
            await LoadSettingsDataAsync();
        }
    }

    private async Task LoadSettingsDataAsync()
    {
        await LoadDrawingsAsync();
        await LoadPcSettingsAsync();
        await LoadUnitConfigurationsAsync();
        await LoadPlcUnitsAsync();
    }

    private bool IsSettingsSelected(string number)
    {
        return !string.IsNullOrWhiteSpace(number)
               && string.Equals(SettingsSelectedAgentNumber, number, StringComparison.OrdinalIgnoreCase);
    }

    private async Task SelectSettingsAgent(DeviceAgentProfile agent)
    {
        var changed = _agentSettingsSelection.Select(AgentState.Agents, agent.Number);
        if (!changed)
        {
            return;
        }

        await LoadSettingsDataAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleSettings()
    {
        if (!CanManageAgents)
        {
            return;
        }

        _settingsOpen = !_settingsOpen;
        if (_settingsOpen)
        {
            _agentSettingsTab = AgentSettingsTab.Register;
            await EnsureSettingsSelectionAsync();
        }
        else
        {
            ClearAgentInputs();
        }
    }

    private void SelectAgentSettingsTab(AgentSettingsTab tab)
    {
        _agentSettingsTab = tab;
    }

    private void OpenUserActions()
    {
        _selectedAction = UserAction.Theme;
        _selectedTheme = PreferencesState.Preferences.Theme;
        _userSettingsOpen = true;
    }

    private void CloseUserSettings()
    {
        _userSettingsOpen = false;
    }

    private void SelectAction(UserAction action)
    {
        _selectedAction = action;
    }

    private void ConfirmLogout()
    {
        NavigationManager.NavigateTo("/logout?confirm=true", forceLoad: true);
    }

    private bool CanManageAgents => isAdmin || isDeveloper;

    private async Task SaveUserSettingsAsync()
    {
        await PreferencesState.UpdateThemeAsync(_selectedTheme);
        _userSettingsOpen = false;
    }

    private async Task RegisterAgentAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(agentNumberInput) || string.IsNullOrWhiteSpace(agentNameInput))
        {
            return;
        }

        _isRegistering = true;
        try
        {
            await AgentState.AddOrUpdateAsync(_userId, agentNumberInput.Trim(), agentNameInput.Trim());
            ClearAgentInputs();
            _settingsOpen = false;
        }
        finally
        {
            _isRegistering = false;
        }
    }

    private async Task ConfirmDeleteAgentAsync(DeviceAgentProfile agent)
    {
        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"エージェント「{agent.Number} - {agent.Name}」を削除しますか？");

        if (!confirmed)
        {
            return;
        }

        await AgentState.RemoveAsync(_userId, agent.Number);
        selectedAgentNumber = AgentState.SelectedAgentNumber ?? string.Empty;
        selectedAgentName = AgentState.Agents.FirstOrDefault(a => a.Number == AgentState.SelectedAgentNumber)?.Name ?? string.Empty;
        await HistoryState.LoadAsync(_userId, AgentState.SelectedAgentNumber);
        StateHasChanged();
    }

    private void CloseOverlay()
    {
        _settingsOpen = false;
        _agentSettingsTab = AgentSettingsTab.Register;
        ClearAgentInputs();
    }

    private void ClearAgentInputs()
    {
        agentNumberInput = string.Empty;
        agentNameInput = string.Empty;
    }

    private async Task LoadDrawingsAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            _drawings = Array.Empty<DrawingDocument>();
            return;
        }

        _drawings = await DrawingService.ListAsync(_userId, SettingsSelectedAgentNumber);
    }

    private async Task LoadPcSettingsAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            _pcSettings = Array.Empty<PcSetting>();
            return;
        }

        _pcSettings = await PcConfigurationService.ListAsync(_userId, SettingsSelectedAgentNumber);
    }

    private async Task LoadUnitConfigurationsAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            _unitConfigurations = Array.Empty<UnitConfiguration>();
            return;
        }

        _unitConfigurations = await UnitConfigurationService.ListAsync(_userId, SettingsSelectedAgentNumber);
    }

    private async Task LoadPlcUnitsAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            _plcUnits = Array.Empty<PlcUnit>();
            return;
        }

        _plcUnits = await PlcService.ListAsync(_userId, SettingsSelectedAgentNumber);
    }

    private async Task OpenDrawingModalForCreate()
    {
        if (!isAdmin)
        {
            await JsRuntime.InvokeVoidAsync("alert", "管理者のみ図面を登録できます");
            return;
        }

        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "装置エージェントを選択してください");
            return;
        }

        _editingDrawingId = null;
        _drawingDescription = string.Empty;
        _drawingFiles.Clear();
        _selectedDrawingFileName = string.Empty;
        _selectedDrawingFileSize = 0;
        _drawingError = null;
        _drawingModalOpen = true;
    }

    private async Task OpenDrawingModalForEdit(DrawingDocument drawing)
    {
        if (!isAdmin)
        {
            await JsRuntime.InvokeVoidAsync("alert", "管理者のみ図面を編集できます");
            return;
        }

        _editingDrawingId = drawing.Id;
        _drawingDescription = drawing.Description ?? string.Empty;
        _selectedDrawingFileName = drawing.FileName;
        _selectedDrawingFileSize = drawing.FileSize;
        _drawingFiles.Clear();
        _drawingError = null;
        _drawingModalOpen = true;
    }

    private void CloseDrawingModal()
    {
        _drawingModalOpen = false;
        _editingDrawingId = null;
        _drawingDescription = string.Empty;
        _drawingFiles.Clear();
        _selectedDrawingFileName = string.Empty;
        _selectedDrawingFileSize = 0;
        _drawingError = null;
    }

    private async Task OnDrawingFilesSelected(InputFileChangeEventArgs args)
    {
        _drawingError = null;
        foreach (var file in args.GetMultipleFiles())
        {
            try
            {
                await using var stream = file.OpenReadStream(_drawingMaxFileSizeBytes);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var buffer = ms.ToArray();

                _drawingFiles.Add(new DrawingFileDraft
                {
                    Id = Guid.NewGuid(),
                    FileName = Path.GetFileName(file.Name),
                    ContentType = file.ContentType,
                    FileSize = buffer.LongLength,
                    Content = buffer
                });
            }
            catch (Exception ex)
            {
                _drawingError = $"ファイルの読み込みに失敗しました: {ex.Message}";
                break;
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    private void RemoveDrawingFile(Guid id)
    {
        _drawingFiles.RemoveAll(f => f.Id == id);
    }

    private async Task SaveDrawingAsync()
    {
        if (_userId is null)
        {
            return;
        }

        _drawingError = null;

        if (!isAdmin)
        {
            _drawingError = "管理者のみ図面を登録できます";
            return;
        }

        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            _drawingError = "装置エージェントを選択してください";
            return;
        }

        _drawingSaving = true;
        try
        {
            if (_editingDrawingId.HasValue)
            {
                var result = await DrawingService.UpdateDescriptionAsync(_userId, _editingDrawingId.Value, _drawingDescription);
                if (!result.Succeeded)
                {
                    _drawingError = result.Error;
                    return;
                }
            }
            else
            {
                if (_drawingFiles.Count == 0)
                {
                    _drawingError = "図面ファイルを選択してください";
                    return;
                }

                var uploads = _drawingFiles.Select(file => new DrawingUpload
                {
                    FileName = file.FileName,
                    ContentType = string.IsNullOrWhiteSpace(file.ContentType) ? "application/octet-stream" : file.ContentType,
                    FileSize = file.Content?.LongLength ?? file.FileSize,
                    Description = _drawingDescription,
                    Content = file.Content
                }).ToList();

                var batchResult = await DrawingService.RegisterManyAsync(_userId, SettingsSelectedAgentNumber, uploads);

                if (!batchResult.Succeeded)
                {
                    _drawingError = batchResult.Error;
                    return;
                }
            }

            await LoadDrawingsAsync();
            CloseDrawingModal();
        }
        finally
        {
            _drawingSaving = false;
        }
    }

    private bool CanSaveDrawing => !_drawingSaving
                                   && isAdmin
                                   && !string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber)
                                   && (_editingDrawingId.HasValue || _drawingFiles.Count > 0);

    private async Task DeleteDrawingAsync(DrawingDocument drawing)
    {
        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"「{drawing.FileName}」を削除しますか？");

        if (!confirmed)
        {
            return;
        }

        var result = await DrawingService.DeleteAsync(_userId, drawing.Id);
        if (!result.Succeeded)
        {
            _drawingError = result.Error;
            return;
        }

        await LoadDrawingsAsync();
    }

    private async Task OpenPcModalForCreate()
    {
        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "装置エージェントを選択してください");
            return;
        }

        _editingPcId = null;
        _pcOs = string.Empty;
        _pcRole = string.Empty;
        _repoInput = string.Empty;
        _repoUrls.Clear();
        _pcError = null;
        _pcModalOpen = true;
    }

    private async Task OpenPcModalForEdit(PcSetting pc)
    {
        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "装置エージェントを選択してください");
            return;
        }

        _editingPcId = pc.Id;
        _pcOs = pc.Os;
        _pcRole = pc.Role ?? string.Empty;
        _repoInput = string.Empty;
        _repoUrls = pc.RepositoryUrls?.Where(r => !string.IsNullOrWhiteSpace(r)).ToList() ?? new List<string>();
        _pcError = null;
        _pcModalOpen = true;
    }

    private void ClosePcModal()
    {
        _pcModalOpen = false;
        _editingPcId = null;
        _pcOs = string.Empty;
        _pcRole = string.Empty;
        _repoInput = string.Empty;
        _repoUrls.Clear();
        _pcError = null;
    }

    private void AddRepositoryUrl()
    {
        _pcError = null;
        var url = _repoInput?.Trim();
        if (string.IsNullOrWhiteSpace(url))
        {
            return;
        }

        if (!Uri.TryCreate(url, UriKind.Absolute, out var uri) ||
            (uri.Scheme != Uri.UriSchemeHttp && uri.Scheme != Uri.UriSchemeHttps))
        {
            _pcError = "リポジトリURLは http/https の絶対URLで入力してください";
            return;
        }

        if (_repoUrls.Any(u => string.Equals(u, url, StringComparison.OrdinalIgnoreCase)))
        {
            _repoInput = string.Empty;
            return;
        }

        _repoUrls.Add(url);
        _repoInput = string.Empty;
    }

    private void HandleRepoKeyDown(KeyboardEventArgs args)
    {
        if (string.Equals(args.Key, "Enter", StringComparison.OrdinalIgnoreCase))
        {
            AddRepositoryUrl();
        }
    }

    private void RemoveRepositoryUrl(string url)
    {
        _repoUrls.RemoveAll(u => string.Equals(u, url, StringComparison.OrdinalIgnoreCase));
    }

    private async Task SavePcAsync()
    {
        if (_userId is null)
        {
            return;
        }

        _pcError = null;

        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            _pcError = "装置エージェントを選択してください";
            return;
        }

        _pcSaving = true;
        try
        {
            var draft = new PcSettingDraft
            {
                Os = _pcOs,
                Role = _pcRole,
                RepositoryUrls = _repoUrls.ToList()
            };

            PcSettingResult result;
            if (_editingPcId.HasValue)
            {
                result = await PcConfigurationService.UpdateAsync(_userId, SettingsSelectedAgentNumber, _editingPcId.Value, draft);
            }
            else
            {
                result = await PcConfigurationService.AddAsync(_userId, SettingsSelectedAgentNumber, draft);
            }

            if (!result.Succeeded)
            {
                _pcError = result.Error;
                return;
            }

            await LoadPcSettingsAsync();
            ClosePcModal();
        }
        finally
        {
            _pcSaving = false;
        }
    }

    private async Task DeletePcSettingAsync(PcSetting pc)
    {
        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"PC設定「{pc.Os}」を削除しますか？");

        if (!confirmed)
        {
            return;
        }

        var deleted = await PcConfigurationService.DeleteAsync(_userId, SettingsSelectedAgentNumber, pc.Id);
        if (!deleted)
        {
            _pcError = "PC設定の削除に失敗しました";
            return;
        }

        await LoadPcSettingsAsync();
    }

    private bool CanSavePc => !_pcSaving
                              && !string.IsNullOrWhiteSpace(_pcOs)
                              && !string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber);

    private async Task OpenUnitModalForCreate()
    {
        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "装置エージェントを選択してください");
            return;
        }

        _editingUnitId = null;
        _unitName = string.Empty;
        _unitDescription = string.Empty;
        _unitDeviceInputs = new List<UnitDeviceInput> { new() };
        _unitError = null;
        _unitModalOpen = true;
    }

    private async Task OpenUnitModalForEdit(UnitConfiguration unit)
    {
        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "装置エージェントを選択してください");
            return;
        }

        _editingUnitId = unit.Id;
        _unitName = unit.Name;
        _unitDescription = unit.Description ?? string.Empty;
        _unitDeviceInputs = (unit.Devices ?? Array.Empty<UnitDevice>())
            .Select(d => new UnitDeviceInput
            {
                Id = d.Id == Guid.Empty ? Guid.NewGuid() : d.Id,
                Name = d.Name,
                Model = d.Model ?? string.Empty,
                Maker = d.Maker ?? string.Empty,
                Description = d.Description ?? string.Empty
            })
            .ToList();
        if (_unitDeviceInputs.Count == 0)
        {
            _unitDeviceInputs.Add(new UnitDeviceInput());
        }

        _unitError = null;
        _unitModalOpen = true;
    }

    private void CloseUnitModal()
    {
        _unitModalOpen = false;
        _editingUnitId = null;
        _unitName = string.Empty;
        _unitDescription = string.Empty;
        _unitDeviceInputs.Clear();
        _unitError = null;
    }

    private void AddUnitDeviceRow()
    {
        _unitDeviceInputs.Add(new UnitDeviceInput());
    }

    private void RemoveUnitDeviceRow(Guid id)
    {
        _unitDeviceInputs.RemoveAll(d => d.Id == id);
    }

    private async Task SaveUnitAsync()
    {
        if (_userId is null)
        {
            return;
        }

        _unitError = null;

        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            _unitError = "装置エージェントを選択してください";
            return;
        }

        _unitSaving = true;
        try
        {
            var draft = new UnitConfigurationDraft
            {
                Name = _unitName,
                Description = _unitDescription,
                Devices = _unitDeviceInputs
                    .Select(d => new UnitDeviceDraft
                    {
                        Name = d.Name ?? string.Empty,
                        Model = string.IsNullOrWhiteSpace(d.Model) ? null : d.Model,
                        Maker = string.IsNullOrWhiteSpace(d.Maker) ? null : d.Maker,
                        Description = string.IsNullOrWhiteSpace(d.Description) ? null : d.Description
                    })
                    .ToList()
            };

            UnitConfigurationResult result;
            if (_editingUnitId.HasValue)
            {
                result = await UnitConfigurationService.UpdateAsync(_userId, SettingsSelectedAgentNumber, _editingUnitId.Value, draft);
            }
            else
            {
                result = await UnitConfigurationService.AddAsync(_userId, SettingsSelectedAgentNumber, draft);
            }

            if (!result.Succeeded)
            {
                _unitError = result.Error;
                return;
            }

            await LoadUnitConfigurationsAsync();
            CloseUnitModal();
        }
        finally
        {
            _unitSaving = false;
        }
    }

    private async Task DeleteUnitConfigurationAsync(UnitConfiguration unit)
    {
        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"装置ユニット「{unit.Name}」を削除しますか？");

        if (!confirmed)
        {
            return;
        }

        var deleted = await UnitConfigurationService.DeleteAsync(_userId, SettingsSelectedAgentNumber, unit.Id);
        if (!deleted)
        {
            _unitError = "装置ユニットの削除に失敗しました";
            return;
        }

        await LoadUnitConfigurationsAsync();
    }

    private bool CanSaveUnit => !_unitSaving
                                && !string.IsNullOrWhiteSpace(_unitName)
                                && !string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber);

    private async Task OpenPlcModalForCreate()
    {
        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "装置エージェントを選択してください");
            return;
        }

        _editingPlcId = null;
        _plcName = string.Empty;
        _plcManufacturer = string.Empty;
        _plcModel = string.Empty;
        _plcRole = string.Empty;
        _plcIp = string.Empty;
        _plcPort = null;
        _commentFile = null;
        _commentFileName = null;
        _commentFileSize = 0;
        _programFiles.Clear();
        _unitInputs.Clear();
        ResetUnitInput();
        _functionBlocks.Clear();
        _fbName = string.Empty;
        _fbLabelFile = null;
        _fbProgramFile = null;
        _fbLabelFileName = null;
        _fbProgramFileName = null;
        _fbError = null;
        _plcError = null;
        _plcModalOpen = true;
    }

    private async Task OpenPlcModalForEdit(PlcUnit unit)
    {
        if (string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            await JsRuntime.InvokeVoidAsync("alert", "装置エージェントを選択してください");
            return;
        }

        _editingPlcId = unit.Id;
        _plcName = unit.Name;
        _plcManufacturer = unit.Manufacturer ?? string.Empty;
        _plcModel = unit.Model ?? string.Empty;
        _plcRole = unit.Role ?? string.Empty;
        _plcIp = unit.IpAddress ?? string.Empty;
        _plcPort = unit.Port;
        _commentFile = null;
        _commentFileName = unit.CommentFile?.FileName;
        _commentFileSize = unit.CommentFile?.FileSize ?? 0;
        _programFiles = (unit.ProgramFiles ?? Array.Empty<PlcFileUpload>())
            .Select(f => new ProgramFileDraft
            {
                Id = f.Id == Guid.Empty ? Guid.NewGuid() : f.Id,
                FileName = f.FileName,
                FileSize = f.FileSize,
                DisplayName = f.DisplayName
            })
            .ToList();
        _editingProgramFileId = null;
        _programDisplayNameInput = string.Empty;
        _unitInputs = unit.Modules
            .Select(m => new PlcModuleDraft { Name = m.Name, Specification = m.Specification })
            .ToList();
        ResetUnitInput();
        _functionBlocks.Clear();
        _fbName = string.Empty;
        _fbLabelFile = null;
        _fbProgramFile = null;
        _fbLabelFileName = null;
        _fbProgramFileName = null;
        _fbError = null;
        _plcError = null;
        _plcModalOpen = true;
        await LoadFunctionBlocksAsync();
    }

    private void ClosePlcModal()
    {
        _plcModalOpen = false;
        _editingPlcId = null;
        _editingProgramFileId = null;
        _programDisplayNameInput = string.Empty;
        _programFiles.Clear();
        _commentFile = null;
        _commentFileName = null;
        _commentFileSize = 0;
        _commentFileContent = null;
        _plcManufacturer = string.Empty;
        ResetUnitInput();
        _functionBlocks.Clear();
        _fbName = string.Empty;
        _fbLabelFile = null;
        _fbProgramFile = null;
        _fbLabelFileName = null;
        _fbProgramFileName = null;
        _fbError = null;
    }

    private async Task OnProgramFilesSelected(InputFileChangeEventArgs args)
    {
        _plcError = null;
        foreach (var file in args.GetMultipleFiles())
        {
            var fileName = Path.GetFileName(file.Name);
            if (!IsCsvFile(fileName))
            {
                _plcError = "プログラムファイルはCSVのみ選択してください";
                continue;
            }

            try
            {
                await using var stream = file.OpenReadStream(_plcMaxFileSizeBytes);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var buffer = ms.ToArray();

                _programFiles.Add(new ProgramFileDraft
                {
                    Id = Guid.NewGuid(),
                    FileName = fileName,
                    FileSize = buffer.LongLength,
                    DisplayName = fileName,
                    Content = buffer
                });
            }
            catch (Exception ex)
            {
                _plcError = $"プログラムファイルの読み込みに失敗しました: {ex.Message}";
                break;
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnCommentFileSelected(InputFileChangeEventArgs args)
    {
        var file = args.File;
        _commentFile = file;
        _commentFileName = Path.GetFileName(file.Name);
        _commentFileSize = file.Size;
        try
        {
            await using var stream = file.OpenReadStream(_plcMaxFileSizeBytes);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            _commentFileContent = ms.ToArray();
            _commentFileSize = _commentFileContent.LongLength;
        }
        catch (Exception ex)
        {
            _plcError = $"コメントファイルの読み込みに失敗しました: {ex.Message}";
            _commentFileContent = null;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task ReplaceProgramFile(Guid id, InputFileChangeEventArgs args)
    {
        _plcError = null;
        var target = _programFiles.FirstOrDefault(f => f.Id == id);
        if (target is null)
        {
            return;
        }

        var file = args.File;
        var fileName = Path.GetFileName(file.Name);
        if (!IsCsvFile(fileName))
        {
            _plcError = "プログラムファイルはCSVのみ選択してください";
            return;
        }

        try
        {
            await using var stream = file.OpenReadStream(_plcMaxFileSizeBytes);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var buffer = ms.ToArray();

            target.FileName = fileName;
            target.FileSize = buffer.LongLength;
            target.Content = buffer;
        }
        catch (Exception ex)
        {
            _plcError = $"プログラムファイルの読み込みに失敗しました: {ex.Message}";
            return;
        }
        if (string.IsNullOrWhiteSpace(target.DisplayName))
        {
            target.DisplayName = fileName;
        }

        await InvokeAsync(StateHasChanged);
    }

    private void BeginEditProgramFile(ProgramFileDraft file)
    {
        _editingProgramFileId = file.Id;
        _programDisplayNameInput = file.DisplayName ?? file.FileName;
    }

    private void SaveProgramFileName()
    {
        if (!_editingProgramFileId.HasValue)
        {
            return;
        }

        var target = _programFiles.FirstOrDefault(f => f.Id == _editingProgramFileId.Value);
        if (target is null)
        {
            return;
        }

        target.DisplayName = string.IsNullOrWhiteSpace(_programDisplayNameInput)
            ? target.FileName
            : _programDisplayNameInput.Trim();

        _editingProgramFileId = null;
        _programDisplayNameInput = string.Empty;
    }

    private void CancelEditProgramFile()
    {
        _editingProgramFileId = null;
        _programDisplayNameInput = string.Empty;
    }

    private void RemoveProgramFile(Guid id)
    {
        _programFiles.RemoveAll(f => f.Id == id);
        if (_editingProgramFileId == id)
        {
            CancelEditProgramFile();
        }
    }

    private void AddOrUpdateUnit()
    {
        if (string.IsNullOrWhiteSpace(_unitNameInput))
        {
            return;
        }

        var draft = new PlcModuleDraft
        {
            Name = _unitNameInput,
            Specification = _unitSpecInput
        };

        if (_editingUnitIndex.HasValue && _editingUnitIndex.Value >= 0 && _editingUnitIndex.Value < _unitInputs.Count)
        {
            _unitInputs[_editingUnitIndex.Value] = draft;
        }
        else
        {
            _unitInputs.Add(draft);
        }

        ResetUnitInput();
    }

    private void EditUnit(int index)
    {
        if (index < 0 || index >= _unitInputs.Count)
        {
            return;
        }

        var unitItem = _unitInputs[index];
        _unitNameInput = unitItem.Name;
        _unitSpecInput = unitItem.Specification ?? string.Empty;
        _editingUnitIndex = index;
    }

    private void RemoveUnit(int index)
    {
        if (index < 0 || index >= _unitInputs.Count)
        {
            return;
        }

        _unitInputs.RemoveAt(index);
        ResetUnitInput();
    }

    private async Task LoadFunctionBlocksAsync()
    {
        if (!_editingPlcId.HasValue || string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            return;
        }

        _fbError = null;
        _fbLoading = true;
        try
        {
            if (_userId is null)
            {
                _fbError = "ユーザー情報を取得できませんでした";
                return;
            }

            var list = await FunctionBlockService.ListAsync(_userId, SettingsSelectedAgentNumber, _editingPlcId.Value, CancellationToken.None);
            _functionBlocks = list.ToList();
        }
        catch (Exception ex)
        {
            _fbError = $"ファンクションブロック取得に失敗しました: {ex.Message}";
        }
        finally
        {
            _fbLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnFunctionBlockLabelSelected(InputFileChangeEventArgs args)
    {
        _fbLabelFile = args.File;
        _fbLabelFileName = Path.GetFileName(args.File.Name);
    }

    private void OnFunctionBlockProgramSelected(InputFileChangeEventArgs args)
    {
        _fbProgramFile = args.File;
        _fbProgramFileName = Path.GetFileName(args.File.Name);
    }

    private async Task UploadFunctionBlockAsync()
    {
        if (!_editingPlcId.HasValue || string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            _fbError = "ユニットを選択してください";
            return;
        }

        if (string.IsNullOrWhiteSpace(_fbName))
        {
            _fbError = "ファンクションブロック名を入力してください";
            return;
        }

        if (_fbLabelFile is null || _fbProgramFile is null)
        {
            _fbError = "ラベルCSVとプログラムCSVを選択してください";
            return;
        }

        _fbError = null;
        _fbUploading = true;
        try
        {
            if (_userId is null)
            {
                _fbError = "ユーザー情報を取得できませんでした";
                return;
            }

            var labelBytes = await ReadFileAsync(_fbLabelFile);
            var programBytes = await ReadFileAsync(_fbProgramFile);

            var draft = new FunctionBlockDraft
            {
                Name = _fbName.Trim(),
                LabelFile = new PlcFileUpload
                {
                    FileName = _fbLabelFileName ?? _fbLabelFile.Name,
                    ContentType = _fbLabelFile.ContentType,
                    FileSize = labelBytes.Length,
                    Content = labelBytes
                },
                ProgramFile = new PlcFileUpload
                {
                    FileName = _fbProgramFileName ?? _fbProgramFile.Name,
                    ContentType = _fbProgramFile.ContentType,
                    FileSize = programBytes.Length,
                    Content = programBytes
                }
            };

            var result = await FunctionBlockService.AddAsync(
                _userId,
                SettingsSelectedAgentNumber,
                _editingPlcId.Value,
                draft,
                CancellationToken.None);

            if (!result.Succeeded)
            {
                _fbError = result.Error ?? "ファンクションブロックの登録に失敗しました";
                return;
            }

            _fbName = string.Empty;
            _fbLabelFile = null;
            _fbProgramFile = null;
            _fbLabelFileName = null;
            _fbProgramFileName = null;
            await LoadFunctionBlocksAsync();
        }
        catch (Exception ex)
        {
            _fbError = $"ファンクションブロックの登録に失敗しました: {ex.Message}";
        }
        finally
        {
            _fbUploading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task DeleteFunctionBlockAsync(FunctionBlock fb)
    {
        if (!_editingPlcId.HasValue || string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"「{fb.Name}」を削除しますか？");

        if (!confirmed)
        {
            return;
        }

        try
        {
            if (_userId is null)
            {
                _fbError = "ユーザー情報を取得できませんでした";
                return;
            }

            var ok = await FunctionBlockService.DeleteAsync(_userId, SettingsSelectedAgentNumber, _editingPlcId.Value, fb.Id, CancellationToken.None);
            if (ok)
            {
                _functionBlocks.RemoveAll(x => x.Id == fb.Id);
            }
            else
            {
                _fbError = "削除に失敗しました";
            }
        }
        catch (Exception ex)
        {
            _fbError = $"削除に失敗しました: {ex.Message}";
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task SavePlcAsync()
    {
        if (_userId is null || string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            _plcError = "装置エージェントを選択してください";
            return;
        }

        _plcError = null;
        _plcSaving = true;
        try
        {
            var draft = new PlcUnitDraft
            {
                Name = _plcName,
                Manufacturer = _plcManufacturer,
                Model = _plcModel,
                Role = _plcRole,
                IpAddress = _plcIp,
                Port = _plcPort,
                Modules = _unitInputs.ToList(),
                CommentFile = _commentFile is not null
                    ? new PlcFileUpload
                    {
                        FileName = _commentFileName ?? string.Empty,
                        ContentType = _commentFile.ContentType,
                        FileSize = _commentFileSize,
                        Content = _commentFileContent
                    }
                    : null,
                ProgramFiles = _programFiles.Select(f => new PlcFileUpload
                {
                    Id = f.Id == Guid.Empty ? Guid.NewGuid() : f.Id,
                    FileName = f.FileName,
                    DisplayName = f.DisplayName,
                    ContentType = "text/csv",
                    FileSize = f.FileSize,
                    Content = f.Content
                }).ToList()
            };

            PlcUnitResult result;
            if (_editingPlcId.HasValue)
            {
                result = await PlcService.UpdateAsync(_userId, SettingsSelectedAgentNumber, _editingPlcId.Value, draft);
            }
            else
            {
                result = await PlcService.AddAsync(_userId, SettingsSelectedAgentNumber, draft);
            }

            if (!result.Succeeded)
            {
                _plcError = result.Error;
                return;
            }

            await LoadPlcUnitsAsync();
            ClosePlcModal();
        }
        finally
        {
            _plcSaving = false;
        }
    }

    private async Task DeletePlcUnitAsync(PlcUnit unit)
    {
        if (_userId is null || string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber))
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"「{unit.Name}」を削除しますか？");

        if (!confirmed)
        {
            return;
        }

        var deleted = await PlcService.DeleteAsync(_userId, SettingsSelectedAgentNumber, unit.Id);
        if (deleted)
        {
            await LoadPlcUnitsAsync();
        }
    }

    private void ResetUnitInput()
    {
        _unitNameInput = string.Empty;
        _unitSpecInput = string.Empty;
        _editingUnitIndex = null;
    }

    private bool CanSavePlc => !_plcSaving
                               && !string.IsNullOrWhiteSpace(SettingsSelectedAgentNumber)
                               && !string.IsNullOrWhiteSpace(_plcName)
                               && !string.IsNullOrWhiteSpace(_plcManufacturer)
                               && !string.IsNullOrWhiteSpace(_plcIp)
                               && _plcPort.HasValue
                               && _plcPort > 0
                               && _plcPort <= 65535;

    private static string DisplayFileName(string? fileName, string? displayName = null)
    {
        var name = string.IsNullOrWhiteSpace(displayName) ? fileName : displayName;
        return string.IsNullOrWhiteSpace(name) ? "未設定" : name;
    }

    private static string FormatPort(int? port)
    {
        return port.HasValue && port.Value > 0 ? port.Value.ToString() : "未設定";
    }

    private static bool IsCsvFile(string fileName)
    {
        return string.Equals(Path.GetExtension(fileName), ".csv", StringComparison.OrdinalIgnoreCase);
    }

    private static async Task<byte[]> ReadFileAsync(IBrowserFile file)
    {
        await using var stream = file.OpenReadStream(_plcMaxFileSizeBytes);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        return ms.ToArray();
    }

    private static string FormatFileSize(long size)
    {
        const double kilo = 1024d;
        const double mega = kilo * 1024d;

        if (size >= mega)
        {
            return $"{size / mega:0.0} MB";
        }

        if (size >= kilo)
        {
            return $"{size / kilo:0.0} KB";
        }

        return $"{size} B";
    }

    private async Task ConfirmDeleteAsync(ConversationSummary summary)
    {
        if (!_loaded)
        {
            await EnsureHistoryAsync();
        }

        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"「{summary.Title}」を削除しますか？");

        if (!confirmed)
        {
            return;
        }

        await HistoryState.DeleteAsync(_userId, summary.Id, AgentState.SelectedAgentNumber);

        if (NavigationManager.Uri.Contains($"c={summary.Id}", StringComparison.Ordinal))
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private void OnPreferencesChanged()
    {
        _ = InvokeAsync(() =>
        {
            _selectedTheme = PreferencesState.Preferences.Theme;
            StateHasChanged();
            return Task.CompletedTask;
        });
    }

    public void Dispose()
    {
        HistoryState.Changed -= OnHistoryChanged;
        AgentState.Changed -= OnAgentStateChanged;
        PreferencesState.Changed -= OnPreferencesChanged;
    }

    private sealed class DrawingFileDraft
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public string FileName { get; set; } = string.Empty;
        public string? ContentType { get; set; }
        public long FileSize { get; set; }
        public byte[]? Content { get; set; }
    }

    private sealed class ProgramFileDraft
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public string FileName { get; set; } = string.Empty;
        public long FileSize { get; set; }
        public string? DisplayName { get; set; }
        public byte[]? Content { get; set; }
    }

    private sealed class UnitDeviceInput
    {
        public Guid Id { get; set; } = Guid.NewGuid();
        public string Name { get; set; } = string.Empty;
        public string? Model { get; set; }
        public string? Maker { get; set; }
        public string? Description { get; set; }
    }

    private enum AgentSettingsTab
    {
        Register,
        List
    }

    private enum UserAction
    {
        Theme,
        Logout
    }
}
