@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using MOCHA.Models.Chat
@inject NavigationManager NavigationManager
@inject MOCHA.Services.Chat.ConversationHistoryState HistoryState
@inject IJSRuntime JsRuntime
@inherits LayoutComponentBase
@implements IDisposable

<div class="sidebar-container @(IsCollapsed ? "collapsed" : string.Empty)">
    <div class="sidebar-header">
        <div class="sidebar-title">
            <img src="icon.png" alt="Chat" class="sidebar-title-icon" />
            <span class="sr-only">Chat</span>
        </div>
        <button class="new-chat-btn" @onclick="StartNewChat">New Chat</button>
        <button class="sidebar-toggle" type="button" @onclick="ToggleAsync" title="サイドバー切替">
            @(IsCollapsed ? "›" : "‹")
        </button>
    </div>

    <div class="sessions-list">
        @if (HistoryState.Summaries.Any())
        {
            @foreach (var item in HistoryState.Summaries.OrderByDescending(h => h.UpdatedAt))
            {
                <div class="session-item" @onclick="() => OpenConversation(item.Id)">
                    <div class="session-content">
                        <div class="history-title">@item.Title</div>
                        <div class="history-time">@item.UpdatedAt.ToLocalTime().ToString("MM/dd HH:mm")</div>
                    </div>
                    <button type="button"
                            class="session-menu-btn"
                            title="履歴を削除"
                            aria-label="履歴を削除"
                            @onclick:stopPropagation="true"
                            @onclick="() => ConfirmDeleteAsync(item)">
                        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                            <path d="M9 3.5h6m-9 3h12M10 10.5v7m4-7v7M5.5 6.5l1 13a1 1 0 0 0 1 .92h9a1 1 0 0 0 1-.92l1-13" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                            <path d="M9 4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                        </svg>
                    </button>
                </div>
            }
        }
        else
        {
            <div class="history-empty">履歴がありません</div>
        }
    </div>

    <div class="user-info">
        <div class="user-avatar">@userInitial</div>
        <div>
            <div class="user-name">@userName</div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsCollapsed { get; set; }
    [Parameter] public EventCallback OnToggle { get; set; }

    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = default!;

    private string userName = "ユーザー";
    private string userInitial = "U";
    private string? _userId;
    private bool _loaded;

    protected override async Task OnInitializedAsync()
    {
        HistoryState.Changed += OnHistoryChanged;
        await EnsureHistoryAsync();
    }

    private Task ToggleAsync() => OnToggle.InvokeAsync();

    private void StartNewChat()
    {
        NavigationManager.NavigateTo("/", forceLoad: true);
    }

    private async Task EnsureHistoryAsync()
    {
        if (_loaded)
        {
            return;
        }

        var authState = await AuthenticationStateTask;
        var principal = authState.User;
        _userId = principal.FindFirst("oid")?.Value
                  ?? principal.FindFirst(ClaimTypes.NameIdentifier)?.Value
                  ?? principal.Identity?.Name
                  ?? "anonymous";
        userName = principal.Identity?.Name
                   ?? principal.FindFirst("name")?.Value
                   ?? "ユーザー";
        userInitial = string.IsNullOrWhiteSpace(userName)
            ? "U"
            : userName[..1].ToUpperInvariant();

        await HistoryState.LoadAsync(_userId);
        _loaded = true;
    }

    private void OnHistoryChanged() => InvokeAsync(StateHasChanged);

    private void OpenConversation(string conversationId)
    {
        var uri = NavigationManager.GetUriWithQueryParameter("c", conversationId);
        NavigationManager.NavigateTo(uri, forceLoad: true);
    }

    private async Task ConfirmDeleteAsync(ConversationSummary summary)
    {
        if (!_loaded)
        {
            await EnsureHistoryAsync();
        }

        if (_userId is null)
        {
            return;
        }

        var confirmed = await JsRuntime.InvokeAsync<bool>(
            "confirm",
            $"「{summary.Title}」を削除しますか？");

        if (!confirmed)
        {
            return;
        }

        await HistoryState.DeleteAsync(_userId, summary.Id);

        if (NavigationManager.Uri.Contains($"c={summary.Id}", StringComparison.Ordinal))
        {
            NavigationManager.NavigateTo("/", forceLoad: true);
        }
    }

    public void Dispose()
    {
        HistoryState.Changed -= OnHistoryChanged;
    }
}
